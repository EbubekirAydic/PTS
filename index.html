<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Para Takip</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;600;800&family=Poppins:wght@300;500&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- Favicon (simple PT initials) -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><rect width=%2264%22 height=%2264%22 rx=%2210%22 fill=%22%236c63ff%22></rect><text x=%2232%22 y=%2238%22 font-size=%2228%22 text-anchor=%22middle%22 fill=%22white%22 font-family=%22Arial%22>PT</text></svg>'>

  <style>
    :root{
      --bg: #f5f6f8;
      --card: #fff;
      --text: #222;
      --muted:#666;
      --accent-1: #6c63ff;
      --accent-2: #00ffd1;
      --income: #00c853;
      --expense: #ff5252;
      --border: rgba(17,17,30,0.06);
    }
    @media (prefers-color-scheme: dark) {
      :root { --prefers-dark: 1; }
    }
    body.dark {
      --bg: #0b0d10;
      --card: #0f1114;
      --text: #e8e8e8;
      --muted:#9a9a9a;
      --accent-1: #8a7bff;
      --accent-2: #00c7ff;
      --border: rgb(255 255 255 / 14%);
    }
    /* Prevent horizontal scrolling and box-sizing */
    html, body { overflow-x: hidden; }
    *, *::before, *::after { box-sizing: border-box; }
    body{
      background: var(--bg);
      color: var(--text);
      font-family: "Poppins", "Montserrat", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      margin:0;
      padding:18px 12px 90px;
      transition: background .25s, color .25s;
    }

    /* Top row: site title + right-controls */
    .topbar {
      max-width:980px;
      margin: 6px auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:6px;
    }
    .site-title {
      display:flex;
      gap:12px;
      align-items:center;
      font-weight:700;
      font-family: 'Montserrat', sans-serif;
      font-size:1.05rem;
    }
    .site-title .logo {
      width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--accent-1),var(--accent-2));
      box-shadow:0 8px 28px rgba(0,0,0,0.08); color:white; font-size:1.2rem;
    }
    .right-controls { display:flex; gap:8px; align-items:center; }

    /* Theme & Advanced button styling (light / dark variants) */
    #themeToggle, #advancedSearchBtn {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:8px;
      font-weight:600;
      color: var(--text);
      background: transparent;
      border: 1px solid var(--border);
      transition: background .18s ease, color .18s ease, transform .12s ease, box-shadow .18s ease;
      box-shadow: none;
      cursor: pointer;
    }

    /* light mode (default) */
    #themeToggle { background: rgba(0,0,0,0.02); }
    #advancedSearchBtn { background: rgba(255,255,255,0.02); }

    #themeToggle:hover, #advancedSearchBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(16,24,40,0.06);
    }

    /* dark mode variants */
    body.dark #themeToggle, body.dark #advancedSearchBtn {
      background: rgba(255,255,255,0.03);
      border-color: rgba(255,255,255,0.06);
      box-shadow: 0 8px 30px rgba(0,0,0,0.28);
      color: var(--text);
    }

    /* subtle pressed state */
    #themeToggle:active, #advancedSearchBtn:active { transform: translateY(0); box-shadow:none; }

    /* ===== Fancy Balance Card ===== */
    .balance-wrap {
      max-width:980px;
      margin: 8px auto 14px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:18px;
      padding: 2px;
    }
    .balance-card {
      width: min(720px, 100%);
      border-radius: 16px;
      padding: 18px 20px;
      position:relative;
      overflow: visible;
      color: #fff;
      background: linear-gradient(135deg, rgba(108,99,255,0.95), rgba(0,255,204,0.9));
      box-shadow: 0 12px 50px rgba(85,60,180,0.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      transform-style: preserve-3d;
    }
    body.dark .balance-card {
      background: linear-gradient(135deg, rgba(138,123,255,1), rgba(0,200,255,0.9));
      box-shadow: 0 18px 60px rgba(120,95,255,0.12);
    }

    .balance-left { display:flex; flex-direction:column; gap:6px;}
    .balance-title { font-family: 'Poppins'; font-weight:300; font-size:.95rem; opacity:.95; color:rgba(255,255,255,0.95); }
    .balance-amount { display:flex; align-items:baseline; gap:8px; }
    .currency { font-family: 'Montserrat'; font-weight:600; font-size: clamp(1.15rem, 2.6vw, 1.4rem); background: linear-gradient(90deg, rgba(255,255,255,0.95), rgba(255,255,255,0.8)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color:transparent; }
    .currency { font-family: 'Montserrat'; font-weight:600; font-size: clamp(1.15rem, 2.6vw, 1.4rem); background: linear-gradient(90deg, rgba(255,255,255,0.95), rgba(255,255,255,0.8)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .currency-badge { font-size: 1.3rem; color: rgba(255,255,255,0.95); }
    .value { font-family:'Montserrat'; font-weight:800; font-size: clamp(2.1rem, 6.8vw, 3.4rem); letter-spacing:-0.03em; line-height:1; color:white; text-shadow: 0 6px 24px rgba(0,0,0,0.18); transition: transform .18s ease; }
    .value.updated { transform: scale(1.06); }

    /* percentage line (moved up) */
    .balance-percent {
      position:absolute;
      top:-12px;
      left:12px;
      background: rgba(255,255,255,0.12);
      padding:6px 10px;
      border-radius:999px;
      font-weight:600;
      font-size:.85rem;
      color:white;
      backdrop-filter: blur(4px);
    }
    body.dark .balance-percent { background: rgba(0,0,0,0.18); }

    .balance-meta { text-align:right; min-width:160px; color: rgba(255,255,255,0.95); }
    .meta-label { font-size:.85rem; opacity:.95; }
    .meta-sub { font-size:.95rem; font-weight:600; margin-top:6px; }

    .glow { position:absolute; inset:auto; right: -40px; top:-20px; width:160px; height:160px; border-radius:50%; filter: blur(30px); opacity:.12; pointer-events:none; background: radial-gradient(circle, rgba(255,255,255,0.6), rgba(255,255,255,0) 30%); }

    /* ===== Filters & UI ===== */
    .filters-row{
      max-width:980px;
      margin: 12px auto;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:space-between;
      padding:8px;
    }
    .filter-left { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .filter-pill{
      background: var(--card);
      border-radius: 10px;
      padding:6px 10px;
      display:flex;
      gap:8px;
      align-items:center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.04);
      border:1px solid var(--border);
    }
    input.form-control, select.form-select {
      background: transparent !important;
      color: var(--text);
      border: 1px solid var(--border) !important;
      border-radius:8px;
      padding:6px 10px;
      min-width:120px;
    }
    input::placeholder { color: rgba(0,0,0,0.35); }
    body.dark input::placeholder { color: rgba(255,255,255,0.35); }

    /* Global button styles to match theme (applies to Bootstrap .btn also) */
    .btn, .btn-sm {
      border-radius: 10px;
      padding: 8px 12px;
      font-weight:600;
      min-height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap:8px;
      transition: background .16s ease, transform .12s ease, box-shadow .12s ease;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text) !important;
    }

    /* Primary / success / danger helpers (preserve bootstrap intent but adapt to theme) */
    .btn-primary {
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      color: #fff !important;
      border: 0;
      border-color: transparent !important;
      box-shadow: 0 10px 30px rgba(80,60,180,0.08);
    }
    .btn-success { background: rgba(0,200,120,0.12); color: var(--text) !important; }
    .btn-danger, .btn-outline-danger { background: rgba(255,80,80,0.06); color: var(--text) !important; }

    /* Outline variants (subtle) */
    .btn-outline-secondary, .btn-outline-primary, .btn-outline-success {
      background: transparent;
      border: 1px solid var(--border) !important;

    }

    body.dark .btn-outline-secondary{
      --bs-btn-hover-bg: #272727;
      --bs-btn-active-bg: #343434;
    }

    .btn-outline-secondary{
      --bs-btn-hover-bg: #ececec;
      --bs-btn-active-bg: #cecece;
    }


    .btn:active, .btn:focus {
      transform: translateY(0);
      box-shadow: 0 6px 18px rgba(16,24,40,0.06);
      outline: none !important;
    }

    /* Make inputs and selects touch friendly and consistent */
    input.form-control, select.form-select, textarea {
      padding: 10px 12px !important;
      border-radius: 10px !important;
      min-height:38px;
      font-size:0.95rem;
    }

    .form-control:focus{
      color: var(--text);
    }

    /* Full-width helper for small screens */
    .w-mobile-full { width: auto; }

    /* Mobile-specific improvements (compact and touch-friendly) */
    @media(max-width:720px){
      body { padding: 12px 10px 90px; }
      .topbar { padding:6px 6px; gap:8px; }
      .site-title { font-size:0.98rem; }
      .site-title .logo { width:40px; height:40px; }
      .right-controls { gap:6px; }
      .user-badge { padding:6px; }

      /* Filters row stack and make actions full-width */
      .filters-row { padding:6px; }
      .filter-left { width:100%; display: grid;}
      .filter-pill { width:100%; display:flex; justify-content:space-between; }
      .filter-pill input.form-control { min-width:0; flex:1; }

      /* Make action buttons easier to tap and full width in their group */
      #openAdd, #advancedSearchBtn, #filterAll, #filterIncome, #filterExpense {
        min-width: 44px; padding:10px 12px; font-size:0.95rem;
      }

      /* Cards stretch and have larger padding */
      .container-cards{ padding: 6px; }
      .record-card { padding:12px; flex-direction:column; align-items:stretch; gap:8px; }
      .record-card > div:last-child { text-align:left; }
      .record-card .btn { width: 48%; }

      /* Floating add button slightly smaller and not cover content */
      .floating-btn { right: 14px; bottom: 18px; width:52px; height:52px; }

      /* Modal adjustments: full width and comfortable padding */
      .modal-box { width: 94%; padding:14px; }
      #advancedSearchContent { opacity:1; margin: 12px auto; }

      /* Chart area scaling */
      #chartWrap { padding: 0 6px; }

      /* Make shared message area comfortable */
      #sharedMessageDisplay { font-size:0.95rem; }
    }

    /* Additional small-screen tweaks to avoid cramped header/filter */
    @media(max-width:720px){
      /* hide the full user badge in topbar (account accessible via bottom nav) */
      .topbar .user-badge { display: none !important; }

      /* hide redundant action buttons in filters since bottom nav covers them */
      #advancedSearchBtn, #openAdd { display: none !important; }

      /* hide small chart preview to save horizontal space */
      #chartPreview { display: none !important; }

      /* ensure search input fills remaining row space */
      .filter-pill { width: 100%; }
      .filter-pill input.form-control { width: 100%; min-width: 0; }

      /* hide migrate/clear local buttons on very small screens (avoid crowding) */
      #migrateLocalBtn, #clearLocalBtn { display: none !important; }
    }

    /* Mobile bottom nav styles */
    #mobileBottomNav { position: fixed; left: 0; right: 0; bottom: 0; z-index:1100; display:none; }
    .mobile-nav-inner { max-width:980px; margin: 0 auto; display:flex; justify-content:space-between; gap:6px; padding:8px; background: var(--card); border-top:1px solid var(--border); box-shadow: 0 -6px 30px rgba(0,0,0,0.06); }
    .mobile-nav-btn { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; padding:6px 6px; border-radius:10px; background:transparent; border:none; color:var(--text); font-size:0.85rem; }
    .mobile-nav-btn.primary { background: linear-gradient(90deg,var(--accent-1),var(--accent-2)); color:#fff; box-shadow: 0 8px 26px rgba(80,60,180,0.12); }
    .mobile-nav-btn .label { font-size:0.72rem; opacity:0.9; }
    .mobile-nav-btn i { font-size:1.05rem; }

    @media(max-width:720px){
      #mobileBottomNav { display:block; }
      /* add bottom padding to body so content isn't covered */
      body { padding-bottom: 84px; }
      /* hide floating add on very small screens since nav has add */
      .floating-btn { display:none; }
    }

    /* Account popup styles */
    .account-popup { position: absolute; right: 10px; top: 62px; width: 260px; z-index:1300; /* visibility/animation controlled by .open */
      display:block; opacity:0; visibility:hidden; pointer-events:none; transform: translateY(-6px); transition: transform .26s cubic-bezier(.2,.9,.18,1), opacity .22s ease, visibility .18s; }
    .account-popup.open { opacity:1; visibility:visible; pointer-events:auto; transform: translateY(0); }
    .account-popup-inner { background: var(--card); border:1px solid var(--border); border-radius:12px; padding:10px; box-shadow: 0 12px 40px rgba(0,0,0,0.12); }
    .ap-header { display:flex; gap:8px; align-items:center; padding-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.03); }
    .ap-avatar { width:44px; height:44px; border-radius:999px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.06); }
    .ap-info { display:flex; flex-direction:column; }
    .ap-info #apName { font-weight:700; }
    .ap-actions { display:flex; flex-direction:column; gap:8px; margin-top:10px; }

    /* Mobile position: anchored above bottom nav and fixed to viewport so it moves with scroll
       Use a slide-up animation on open (starts slightly below and moves up). */
    @media(max-width:720px){
      .account-popup { position: fixed; left: 12px; right: 12px; top: auto; bottom: 84px; width: auto; transform: translateY(12px); }
      .account-popup.open { transform: translateY(0); }
    }
    @media(min-width:720px){
      #mobileBottomNav { display:none; }
      /* add bottom padding to body so content isn't covered */
      body { padding-bottom: 84px; }
      /* hide floating add on very small screens since nav has add */
      .floating-btn { display:none; }
    }

    /* cards */
    .container-cards{ max-width:980px; margin: 18px auto 120px; }
    .record-card{
      background: var(--card);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow: 0 8px 26px rgba(17,17,30,0.04);
      border-left: 6px solid transparent;
      border:1px solid var(--border);
    }
    .record-card.income{ border-left-color: var(--income); }
    .record-card.expense{ border-left-color: var(--expense); }
    .tag-chip{ display:inline-block; margin-left:6px; font-size:.82rem; padding:4px 8px; border-radius:999px; background: rgba(0,0,0,0.06); }

    /* modal */
    .modal-overlay { 
      position: fixed; 
      inset:0; display:flex; 
      align-items:center; 
      justify-content:center; 
      background: rgba(0,0,0,0.35); 
      z-index:1200; 
      opacity:0; 
      pointer-events:none; 
      transition: opacity 0.26s ease; }
    .modal-overlay.show { opacity:1; pointer-events:auto; }
    .modal-overlay.closing { opacity:0; pointer-events:none; }
    .modal-box { 
      width: min(640px,94%); 
      background: var(--card); 
      border-radius:12px; 
      padding:18px; 
      box-shadow: 0 30px 80px rgba(0,0,0,0.4); 
      border:1px solid var(--border); 
      transform: translateY(-12px); 
      opacity:0; 
      transition: transform 0.28s cubic-bezier(.2,.9,.18,1), opacity 0.22s ease; 
    }

    .modal-overlay.show .modal-box { transform: translateY(0); opacity:1; }
    .modal-overlay.closing .modal-box { transform: translateY(-12px); opacity:0; }

    /* amount input states (green for income, red for expense) with subtle animated pulse */
    .amount-input{ transition: box-shadow .28s ease, background-color .28s ease, border-color .26s ease, color .18s ease, transform .18s ease; border:1px solid rgba(0,0,0,0.04); }

    /* subtle pulsing glow for income */
    @keyframes incomePulse {
      0% { box-shadow: 0 8px 18px rgba(16,185,129,0.06), 0 0 0 0 rgba(16,185,129,0.00); transform: translateY(0); background-position: 0% 50%; }
      50% { box-shadow: 0 14px 40px rgba(16,185,129,0.10), 0 0 18px 6px rgba(16,185,129,0.04); transform: translateY(-2px); background-position: 50% 50%; }
      100% { box-shadow: 0 8px 18px rgba(16,185,129,0.06), 0 0 0 0 rgba(16,185,129,0.00); transform: translateY(0); background-position: 100% 50%; }
    }

    /* subtle pulsing glow for expense */
    @keyframes expensePulse {
      0% { box-shadow: 0 8px 18px rgba(244,67,54,0.06), 0 0 0 0 rgba(244,67,54,0.00); transform: translateY(0); background-position: 0% 50%; }
      50% { box-shadow: 0 14px 40px rgba(244,67,54,0.10), 0 0 18px 6px rgba(244,67,54,0.04); transform: translateY(-2px); background-position: 50% 50%; }
      100% { box-shadow: 0 8px 18px rgba(244,67,54,0.06), 0 0 0 0 rgba(244,67,54,0.00); transform: translateY(0); background-position: 100% 50%; }
    }

    .amount-input.income{ background: linear-gradient(90deg, rgba(16,185,129,0.10), rgba(16,185,129,0.02)); background-size: 200% 200%; border-color: rgba(16,185,129,0.22); color: #00b66a; animation: incomePulse 3s ease-in-out infinite; }
    .amount-input.expense{ background: linear-gradient(90deg, rgba(244,67,54,0.10), rgba(244,67,54,0.02)); background-size: 200% 200%; border-color: rgba(244,67,54,0.22); color: #e53935; animation: expensePulse 3s ease-in-out infinite; }

    /* animated select styling (match input feel) */
    /* make select look like a pill and use card background (white in light, dark in dark mode) */
    #d_type{
      transition: box-shadow .28s ease, border-color .26s ease, transform .18s ease, background-color .18s ease, color .18s ease;
      -webkit-appearance: none; appearance: none;
      background: var(--card);
      border-radius: 10px;
      padding-right: 36px; /* space for custom arrow */
      position: relative;
      border: 1px solid rgba(0,0,0,0.06);
      color: var(--text);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24'%3E%3Cpath fill='%23999' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 12px 12px;
    }
    /* color accents and subtle lift when the select reflects income/expense */
    #d_type.income{ box-shadow: 0 8px 22px rgba(16,185,129,0.06); border-color: rgba(16,185,129,0.16); transform: translateY(-1px); color: #00b66a; background: linear-gradient(90deg, rgba(16,185,129,0.02), var(--card)); }
    #d_type.expense{ box-shadow: 0 8px 22px rgba(244,67,54,0.06); border-color: rgba(244,67,54,0.16); transform: translateY(-1px); color: #e53935; background: linear-gradient(90deg, rgba(244,67,54,0.02), var(--card)); }

    /* style the dropdown options when possible (browser support varies) */
    #d_type option { padding: 6px 8px; }
    #d_type option.opt-income { background: linear-gradient(90deg, rgba(16,185,129,0.06), rgba(16,185,129,0.01)); color: #007a4d; }
    #d_type option.opt-expense { background: linear-gradient(90deg, rgba(244,67,54,0.06), rgba(244,67,54,0.01)); color: #b71c1c; }
    /* ensure checked/active options remain readable */
    #d_type option:checked, #d_type option:active { outline: none; }

    /* For dark-mode ensure selected pill contrasts (var(--card) becomes dark automatically) */
    body.dark #d_type { color: var(--text); }

  /* login modal styles */
  .login-modal { position: fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.35); z-index:1250; }
  .login-box { width: min(440px,94%); background: var(--card); border-radius:12px; padding:18px; box-shadow: 0 24px 60px rgba(0,0,0,0.28); border:1px solid var(--border); }
  .login-box h5 { margin:0 0 8px 0; }
  .login-error { color: #c0392b; display:none; margin-bottom:8px; }

    /* floating add button */
    .floating-btn{ position: fixed; right: 22px; bottom: 22px; width:56px; height:56px; border-radius:50%; background: linear-gradient(135deg,var(--accent-1),var(--accent-2)); color:#fff; display:flex; align-items:center; justify-content:center; font-size:1.6rem; box-shadow: 0 12px 36px rgba(80,60,180,0.18); z-index:1001; border:none; }

    /* small user badge */
    .user-badge { display:flex; gap:8px; align-items:center; background:var(--card); padding:6px 8px; border-radius:999px; border:1px solid var(--border); }
    .user-avatar { width:34px; height:34px; border-radius:999px; overflow:hidden; display:inline-flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.06); }

    /* responsive tweaks */
    @media(max-width:720px){
      .balance-left { align-items: center; align-self: center;}
      .balance-meta { text-align:left; min-width:160px; color: rgba(255,255,255,0.95); }
      .value { font-size: clamp(1.6rem, 10vw, 2.6rem); }
      .balance-card { padding: 14px; border-radius:14px; flex-direction:column; align-items:flex-start; gap:12px; }
      .meta-sub { font-size:.9rem; }
      .filters-row { flex-direction:column; align-items:stretch; gap:10px; }
      .filter-pill { flex:1; justify-content:center; }
      .floating-btn { right:14px; bottom:14px; width:52px; height:52px; }
      .balance-percent { position:static; margin-bottom:8px; }
      /* Mobile: record card layout tweak - left column: note (top) + date/tags (bottom); right column: amount + actions */
      .record-card{
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px;
      }
      .record-card > div:first-child{
        /* left column: take remaining space, stack note and meta */
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .record-card > div:first-child .small {
        font-size: 0.92rem;
        color: var(--muted);
      }
      .record-card > div:last-child{
        /* right column: amount and actions, align to right */
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
        min-width: 110px;
      }
      .record-card .btn {
        padding: 6px 8px;
        font-size: 0.88rem;
        min-height: 34px;
      }
      .record-card .tag-chip { margin-left:6px; font-size:0.8rem; }
    }

    .mt-2{
        display: flex;
        width: 100%;
        justify-content: flex-end;
    }
  /* Analysis area controls */
  .analysis-area { 
    background: #131722; 
    border:1px solid rgba(255,255,255,0.1); 
    border-radius:12px; 
    padding:12px; 
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    margin-bottom:12px;
    color: #e8e8e8;
  }
  .analysis-area canvas {
    background: #131722;
  }
  .analysis-range { display:flex; gap:8px; flex-wrap:wrap; }
  .analysis-range .btn { 
    padding:6px 10px; 
    font-size:0.88rem;
    color: #e8e8e8 !important;
    border-color: rgba(255,255,255,0.1) !important;
  }
  .analysis-area .btn-outline-secondary {
    color: #e8e8e8 !important;
    border-color: rgba(255,255,255,0.1) !important;
  }
  .analysis-area .btn-outline-secondary:hover {
    background: rgba(255,255,255,0.1);
  }
  .analysis-area .btn-outline-secondary.active {
    background: rgba(255,255,255,0.15);
  }
  
  /* Chart Settings Collapsible Styles */
  .chart-settings-container {
    margin: 8px 0;
    width: 100%;
    max-width: 600px;
  }
  
  .collapsible-btn {
    width: 100%;
    display: flex !important;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px !important;
    transition: all 0.3s ease;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .collapsible-btn:hover {
    background: rgba(255,255,255,0.1);
  }
  
  .collapsible-btn.active {
    background: rgba(255,255,255,0.15);
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    border-bottom-color: transparent;
  }
  
  .collapsible-btn i {
    transition: transform 0.3s ease;
  }
  
  .collapsible-btn.active i {
    transform: rotate(180deg);
  }
  
  .collapsible-content {
    height: 0;
    padding: 0;
    overflow: hidden;
    transition: all 0.3s ease;
    opacity: 0;
    background: rgba(255,255,255,0.03);
    border-radius: 0 0 8px 8px;
    border: 1px solid transparent;
  }
  
  .collapsible-content.open {
    height: auto;
    min-height: 180px;
    opacity: 1;
    padding: 15px;
    border: 1px solid rgba(255,255,255,0.1);
    border-top: none;
  }
  
  .settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
  }
  
  .settings-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .settings-item input[type="color"] {
    height: 35px;
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.1);
    background: #131722;
  }
  .analysis-area .form-select {
    background: #131722 !important;
    color: #e8e8e8 !important;
    border-color: rgba(255,255,255,0.1) !important;
  }
  /* Delete confirmation modal */
  #deleteConfirmModal {
    position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 2500;
  }
  #deleteConfirmModal .modal-inner { background: var(--card); border-radius: 10px; padding:16px; width:320px; max-width:90%; box-shadow:0 12px 40px rgba(0,0,0,0.28); transform: translateY(-10px); opacity:0; transition: all 220ms ease; border:1px solid var(--border); }
  #deleteConfirmModal.show .modal-inner { transform: translateY(0); opacity:1; }
  #deleteConfirmModal .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

  /* Mobile balance search modal */
  #balanceSearchModal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index:2600; }
  #balanceSearchModal .inner { background: var(--card); padding:14px; border-radius:10px; width:360px; max-width:94%; box-shadow:0 12px 40px rgba(0,0,0,0.28); border:1px solid var(--border); transform: translateY(10px); opacity:0; transition:all 200ms ease; }
  #balanceSearchModal.show .inner { transform: translateY(0); opacity:1; }
  #balanceSearchModal input { font-size:1.1rem; padding:8px 10px; border-radius:6px; border:1px solid var(--border); background:transparent; color:var(--muted); width:100%; box-sizing:border-box }
  /* Scroll-up indicator (desktop only) */
  #scrollUpIndicator {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1800;
    display: none;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 20px;
    background: var(--card);
    border: 1px solid var(--border);
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    cursor: pointer;
  }
  #scrollUpIndicator i { color: var(--muted); }
  @media (max-width: 767px) { #scrollUpIndicator { display: none !important; } }
  .analysis-area label {
    color: #9f9fa8;
  }
  </style>
</head>
<body>

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="site-title">
    <div class="logo" aria-hidden><i class="fas fa-wallet" style="font-size:1.1rem"></i></div>
      <div>
        <div style="font-size:.9rem; opacity:.75">Para Takip</div>
        <div style="font-size:.78rem; color:var(--muted)">Hesap ve gider takibi</div>
      </div>
    </div>

    <div class="right-controls">
      <!-- Theme toggle -->
      <button id="themeToggle" class="btn btn-sm btn-outline-secondary" title="Tema değiştir" style="border:1px solid var(--border);"><i class="fa-solid fa-circle-half-stroke"></i></button>

      <!-- User (login) -->
      <div id="authArea" class="user-badge">
        <div id="userAvatar" class="user-avatar"><i class="fas fa-user" style="font-size:1rem"></i></div>
        <div id="userInfo" style="font-size:.85rem">Giriş yok</div>
        <button id="authBtn" class="btn btn-sm btn-outline-primary" style="margin-left:8px">Giriş</button>
        <button id="migrateLocalBtn" class="btn btn-sm btn-outline-success" style="margin-left:8px; display:none">Yerel Veriyi Taşı</button>
        <button id="clearLocalBtn" class="btn btn-sm btn-outline-danger" style="margin-left:8px; display:none">Yereli Sil</button>
      </div>

      <!-- Account popup (desktop and mobile anchored) -->
        <div id="accountPopup" class="account-popup" aria-hidden="true">
        <div class="account-popup-inner">
          <div class="ap-header">
            <div class="ap-avatar" id="apAvatar"><i class="fas fa-user"></i></div>
            <div class="ap-info">
              <div id="apName">Giriş yok</div>
              <div id="apStatus" class="muted" style="font-size:.85rem">Henüz giriş yapılmadı</div>
            </div>
          </div>
              <div class="ap-actions">
                <button id="apSignIn" class="btn btn-sm btn-outline-primary" style="display:none">Giriş Yap</button>
                <button id="apMigrate" class="btn btn-sm btn-outline-success">Yereli Taşı</button>
                <button id="apClear" class="btn btn-sm btn-outline-danger">Yereli Sil</button>
                <button id="apExport" class="btn btn-sm btn-outline-secondary">Veriyi Dışa Aktar</button>
                <button id="apImport" class="btn btn-sm btn-outline-secondary">Veriyi İçe Aktar</button>
                <input id="importFile" type="file" accept="application/json" style="display:none" />
                <button id="apSignOut" class="btn btn-sm btn-outline-primary">Çıkış Yap</button>
              </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fixed top scroll-up indicator (desktop only) -->
  <div id="scrollUpIndicator" role="button" tabindex="0" title="Yukarıya git"><i class="fas fa-arrow-up"></i></div>

  <!-- BALANCE CARD -->
  <div class="balance-wrap">
    <div class="balance-card" role="region" aria-label="Toplam bakiye">
      <div class="balance-percent" id="percentBadge">—</div>

      <div class="balance-left">
        <div class="balance-title">Toplam Bakiye</div>
        <div class="balance-amount" aria-hidden="true">
          <div class="currency-badge" id="currencyBadge">₺</div>
          <div id="balanceValue" class="value">0,00</div>
        </div>
      </div>

      <div class="balance-meta">
        <div class="meta-label">Durum</div>
        <div id="metaSub" class="meta-sub">Güncel</div>
      </div>

      <div class="glow" aria-hidden="true"></div>
    </div>
  </div>

  <!-- Filters row -->
  <div class="filters-row" id="filtersRow">
    <div class="filter-left">
      <div class="filter-pill">
        <button id="filterAll" class="btn btn-sm btn-outline-secondary">Tümü</button>
        <button id="filterIncome" class="btn btn-sm btn-outline-secondary ms-1">Gelir</button>
        <button id="filterExpense" class="btn btn-sm btn-outline-secondary ms-1">Gider</button>
      </div>
      <div class="filter-pill" style="display:flex; align-items:center;">
        <input id="searchNote" type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="form-control form-control-sm" placeholder="Ara...">
      </div>
    </div>

    <div style="display:flex; gap:8px; align-items:center;">
      <!-- Chart small preview -->
      <div id="chartPreview" style="width:120px; height:64px;"></div>
      <!-- Advanced button opens full modal too -->
       <!-- Advanced search moved into topbar as requested -->
      <button id="advancedSearchBtn" class="btn btn-sm btn-outline-secondary" style="background:transparent; border:1px solid var(--border);">
        <i class="fa-solid fa-magnifying-glass-dollar"></i> Gelişmiş
      </button>
      <!-- Quick jump to analysis/chart area for desktop users -->
      <button id="gotoChartBtn" class="btn btn-sm btn-outline-secondary" title="Grafiğe git" style="background:transparent; border:1px solid var(--border);">
        <i class="fas fa-chart-line"></i> Grafik
      </button>
      <!-- New entry + floating remains -->
      <button id="openAdd" class="btn btn-sm btn-success">+ Yeni</button>
    </div>
  </div>

  <!-- Cards area -->
  <div class="container-cards" id="records"></div>

  <!-- Chart placeholder (bigger) -->
  <div id="chartWrap" style="max-width:980px;margin:10px auto"></div>

  <!-- Floating add -->
  <button class="floating-btn" id="floatingAdd">+</button>

  <!-- Mobile bottom navigation (visible on small screens) -->
  <nav id="mobileBottomNav" aria-label="Mobil menü">
    <div class="mobile-nav-inner">
      <button id="navHome" class="mobile-nav-btn"><i class="fas fa-wallet"></i><div class="label">Bakiye</div></button>
      <button id="navSearch" class="mobile-nav-btn"><i class="fa-solid fa-magnifying-glass-dollar"></i><div class="label">Ara</div></button>
      <button id="navAdd" class="mobile-nav-btn primary"><i class="fas fa-plus"></i><div class="label">Yeni</div></button>
  <button id="navShared" class="mobile-nav-btn"><i class="fas fa-chart-pie"></i><div class="label">Analiz</div></button>
      <button id="navAccount" class="mobile-nav-btn"><i class="fas fa-user"></i><div class="label">Hesap</div></button>
    </div>
  </nav>

  <!-- Modal (add/edit) -->
  <div id="modalOverlay" class="modal-overlay" style="display:none;">
    <div class="modal-box">
      <h5 id="modalTitle">Yeni İşlem</h5>
      <div class="row g-2 mt-2">
        <div class="col-12 col-md-4" style="display:flex; align-items:center; gap:8px;">
          <label for="d_type" style="font-size:.9rem; margin-right:6px; white-space:nowrap">Tür:</label>
          <select id="d_type" class="form-select form-select-sm" style="min-width:140px">
            <!-- Note: we add classes on options so we can style dropdown entries where supported -->
            <option value="income" class="opt-income">Gelir</option>
            <option value="expense" class="opt-expense">Gider</option>
          </select>
        </div>
        <div class="col-12 col-md-8"><input id="d_amount" class="form-control amount-input" placeholder="Tutar (+/-)"></div>
        <div class="col-12 mt-2"><input id="d_note" class="form-control" placeholder="Not"></div>
        <div class="col-12 mt-2"><input id="d_tags" class="form-control" placeholder="Etiket (virgülle)"></div>
        <div class="col-6 mt-2"><input id="d_date" type="date" class="form-control"></div>
        <div class="col-6 mt-2"><button id="d_save" class="btn btn-primary w-100">Kaydet</button></div>
        <div class="col-12 mt-2 text-end"><button id="d_close" class="btn btn-sm btn-outline-secondary">Kapat</button></div>
      </div>
    </div>
  </div>

  <!-- Advanced Search Modal -->
  <div id="advancedSearchModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:1200; align-items:center; justify-content:center; padding:12px;">
    <div id="advancedSearchContent" style="background:var(--card); border-radius:12px; max-width:520px; width:100%; padding:20px; box-shadow:0 12px 40px rgba(0,0,0,0.3); transform:translateY(-20px); opacity:0; transition:0.22s;">
      <h5 style="margin-bottom:12px;">Gelişmiş Arama</h5>

      <!-- Tutar Aralığı -->
      <div class="d-flex gap-2 mb-2">
        <input id="adv_minAmount" type="number" placeholder="Min Tutar" class="form-control">
        <input id="adv_maxAmount" type="number" placeholder="Max Tutar" class="form-control">
      </div>

      <!-- Tarih Aralığı -->
      <div class="d-flex gap-2 mb-2">
        <input id="adv_startDate" type="date" class="form-control">
        <input id="adv_endDate" type="date" class="form-control">
      </div>

      <!-- Etiket Arama -->
      <div class="mb-2"><input id="adv_tag" type="text" placeholder="Etiket (virgülle)" class="form-control"></div>

      <!-- Buttons -->
      <div class="d-flex justify-content-end gap-2">
        <button id="adv_apply" class="btn btn-primary">Uygula</button>
        <button id="adv_close" class="btn btn-outline-secondary">Kapat</button>
      </div>
    </div>
  </div>

  <!-- (removed) shared message debug area; replaced by chart area focus target -->

    <!-- Login modal -->
    <div id="loginModal" class="login-modal">
      <div class="login-box">
        <h5>Giriş Yap</h5>
        <div id="loginError" class="login-error"></div>
        <div class="mb-2"><input id="loginEmail" type="email" class="form-control" placeholder="E-posta"></div>
        <div class="mb-2"><input id="loginPass" type="password" class="form-control" placeholder="Şifre"></div>
        <div class="d-flex gap-2 mb-2">
          <button id="loginSignIn" class="btn btn-primary">Giriş Yap</button>
          <button id="loginCreate" class="btn btn-outline-secondary">Hesap Oluştur</button>
          <button id="loginClose" class="btn btn-sm btn-outline-secondary ms-auto">Kapat</button>
        </div>
        <div style="text-align:center; margin-top:6px;">veya</div>
        <div style="margin-top:8px; display:flex; justify-content:center;"><button id="loginGoogle" class="btn btn-outline-primary"><i class="fab fa-google"></i> Google ile Giriş</button></div>
      </div>
    </div>
  
  <!-- Single Delete confirmation modal (one instance) -->
  <div id="deleteConfirmModal" aria-hidden="true">
    <div class="modal-inner">
      <div style="font-weight:700;">Bu kaydı silmek istediğinize emin misiniz?</div>
      <div style="margin-top:8px; color:var(--muted); font-size:.95rem">Silme işlemi geri alınamaz.</div>
      <div class="modal-actions">
        <button id="cancelDeleteBtn" class="btn btn-sm btn-outline-secondary">İptal</button>
        <button id="confirmDeleteBtn" class="btn btn-sm btn-danger">Sil</button>
      </div>
    </div>
  </div>

  <!-- Single Mobile balance search modal (one instance) -->
  <div id="balanceSearchModal" aria-hidden="true">
    <div class="inner">
      <div style="font-weight:700; margin-bottom:8px">Bakiye Ara (TL)</div>
      <input id="balanceSearchInput" type="number" inputmode="decimal" placeholder="Tutar gir (örn. 1234.50)">
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px">
        <button id="balanceSearchCancel" class="btn btn-sm btn-outline-secondary">İptal</button>
        <button id="balanceSearchOk" class="btn btn-sm btn-primary">Ara</button>
      </div>
    </div>
  </div>

<script type="module">

  // Quick runtime checks: confirm script is loaded and capture uncaught errors.
    try { /* module loaded (log suppressed per user request) */ } catch(e){}
  function settingsLog(...args){
    try{
      const txt = args.map(a => {
        try{ return typeof a === 'string' ? a : JSON.stringify(a); } catch(e){ return String(a); }
      }).join(' ');
      const time = (new Date()).toISOString().replace('T',' ').slice(0,19);
      const line = `[${time}] ${txt}`;
      // write to console for settings-related debugging
      try { console.log(line); } catch(e){}
      // attempt to send to server in background (best-effort)
      try{ serverLog(line); } catch(e){}
    }catch(e){ /* swallow */ }
  }
  // Send log to server (Firebase RTDB) when possible; fallback to local pending queue
  async function serverLog(line){
    try{
      if(typeof push === 'function' && db){
        const path = (currentUser && currentUser.uid) ? `users/${currentUser.uid}/appLogs` : `anon/appLogs`;
        // push a small object: timestamp and text
        await push(ref(db, path), { ts: Date.now(), txt: line });
        return true;
      }
    }catch(e){ /* ignore */ }
    // fallback: store locally to flush later
    try{
      const key = 'pts_pending_logs_v1';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      arr.push({ ts: Date.now(), txt: line });
      localStorage.setItem(key, JSON.stringify(arr));
    }catch(e){ /* swallow */ }
    return false;
  }

  // Flush any pending logs from localStorage to user's DB (call when user signs in)
  async function flushPendingLogs(){
    try{
      const key = 'pts_pending_logs_v1';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      if(!arr || !arr.length) return;
      if(!currentUser || !currentUser.uid) return; // keep queued until user available
      const path = `users/${currentUser.uid}/appLogs`;
      for(const it of arr){
        try{ await push(ref(db, path), { ts: it.ts || Date.now(), txt: it.txt || '' }); } catch(e){ /* leave rest queued */ return; }
      }
      // cleared all
      localStorage.removeItem(key);
    }catch(e){ /* ignore */ }
  }
  window.addEventListener('error', function(ev){ try { console.error('Uncaught error:', ev.message, ev.filename + ':' + ev.lineno + ':' + ev.colno); } catch(e){} });

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

  // --- YOUR FIREBASE CONFIG (use your own; currently filled with your earlier values) ---
  const firebaseConfig = {
    apiKey: "AIzaSyABNm4D3GUmdGyCGfTcMe5FyzkqjPeXeBU",
    authDomain: "hesapkitapsync.firebaseapp.com",
    databaseURL: "https://hesapkitapsync-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "hesapkitapsync",
  storageBucket: "hesapkitapsync.appspot.com",
    messagingSenderId: "1048429648839",
    appId: "1:1048429648839:web:1b6a9a0eefe7490cff57e2",
    measurementId: "G-6Y4PR5CB2M"
  };

  // initialize
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // database refs
  let recordsRef = null; // will point to users/{uid}/records when signed in
  let recordsUnsub = null;
  const sharedMsgRef = ref(db, 'sharedMessage');    // single shared text

  // Attach listener for a specific user's records path
  function attachRecordsListenerForUser(uid){
    dbg('[attach] attachRecordsListenerForUser', uid);
    // detach previous listener if exists
    try { if(typeof recordsUnsub === 'function') recordsUnsub(); } catch(e){}
    recordsRef = ref(db, `users/${uid}/records`);
    recordsUnsub = onValue(recordsRef, snapshot => {
      const val = snapshot.val() || {};
      // seed from localStorage if DB empty
      if(!val){
        const local = localStorage.getItem('hesapkitap_records_v2');
        if(local){
          try {
            const arr = JSON.parse(local);
            const obj = {};
            for(const r of arr) obj[r.id || (Date.now()+Math.random())] = r;
            set(recordsRef, obj).then(()=> dbg('[attach] Seeded user DB from localStorage'));
          } catch(e){ console.error('[attach] seed parse error', e); }
        }
      }
      const arr = Object.keys(val).map(k => Object.assign({ id: k }, val[k]));
      records = arr;
      window.records = records;
      if(typeof editingId === 'string' && !records.find(r=>r.id === editingId)) editingId = null;
      dbg('[attach] received', records.length, 'records for user', uid);
      renderRecords();
    });
  }

  // wire saveRecords to push to firebase (overwrite with current records)
  window.saveRecords = function(){
    // write entire records array (as object keyed by id to avoid array sparse issues)
    const obj = {};
    for(const r of (records || [])) obj[r.id] = r;
    // keep window.records in sync for any external callers
    window.records = records;
    try {
      if(recordsRef){
        dbg('[saveRecords] currentUser=', currentUser && currentUser.uid, 'writing', Object.keys(obj).length, 'items');
          set(recordsRef, obj).then(()=> dbg('[saveRecords] DB write ok')).catch(err => {
            if(DEBUG) console.error('[saveRecords] DB write failed', err);
            try { localStorage.setItem('hesapkitap_records_v2', JSON.stringify(records)); dbg('[saveRecords] backup saved to localStorage'); } catch(e){}
        });
      } else {
        dbg('[saveRecords] no recordsRef; saving to localStorage');
        try { localStorage.setItem('hesapkitap_records_v2', JSON.stringify(records)); } catch(e){}
      }
    } catch(e){
      console.error('saveRecords error', e);
      try { localStorage.setItem('hesapkitap_records_v2', JSON.stringify(records)); } catch(err){}
    }
  };
  

  // shared message area removed; no-op

  // AUTH: simple modalless flow: sign in with Google or email prompt (simple)
  const provider = new GoogleAuthProvider();

  // Auth button: if signed-in -> sign out, otherwise open login modal
  const authBtnEl = document.getElementById('authBtn');
  authBtnEl.addEventListener('click', async () => {
    if (auth.currentUser) {
      await signOut(auth);
    } else {
      openLoginModal();
    }
  });

  // Login modal wiring
  const loginModal = document.getElementById('loginModal');
  const loginClose = document.getElementById('loginClose');
  const loginSignIn = document.getElementById('loginSignIn');
  const loginCreate = document.getElementById('loginCreate');
  const loginGoogle = document.getElementById('loginGoogle');
  const loginError = document.getElementById('loginError');

  function openLoginModal(){ if(loginModal) loginModal.style.display = 'flex'; }
  function closeLoginModal(){ if(loginModal) loginModal.style.display = 'none'; loginError.style.display='none'; }

  loginClose.addEventListener('click', closeLoginModal);

  loginSignIn.addEventListener('click', async () => {
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value;
    if(!email || !pass){ loginError.textContent = 'E-posta ve şifre girin'; loginError.style.display='block'; return; }
    try{ await signInWithEmailAndPassword(auth, email, pass); closeLoginModal(); }
    catch(e){ loginError.textContent = e.message || 'Giriş başarısız'; loginError.style.display='block'; }
  });

  loginCreate.addEventListener('click', async () => {
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value;
    if(!email || !pass){ loginError.textContent = 'E-posta ve şifre girin'; loginError.style.display='block'; return; }
    try{ await createUserWithEmailAndPassword(auth, email, pass); closeLoginModal(); }
    catch(e){ loginError.textContent = e.message || 'Oluşturma başarısız'; loginError.style.display='block'; }
  });

  loginGoogle.addEventListener('click', async () => {
    try{ await signInWithPopup(auth, provider); closeLoginModal(); } catch(e){ loginError.textContent = e.message || 'Google giriş hatası'; loginError.style.display='block'; }
  });

  // Make apSignIn open login modal as well
  try{ if(apSignIn) apSignIn.addEventListener('click', ()=> openLoginModal()); } catch(e){}

  onAuthStateChanged(auth, user => {
    dbg('[auth] onAuthStateChanged, user=', user && user.uid);
    currentUser = user;
    if(user){
      document.getElementById('userInfo').textContent = user.displayName || user.email;
      if(user.photoURL) document.getElementById('userAvatar').innerHTML = `<img src="${user.photoURL}" style="width:100%;height:100%;object-fit:cover">`;
      document.getElementById('authBtn').textContent = 'Çıkış';
      // attach per-user listener
      try{ attachRecordsListenerForUser(user.uid); } catch(e){ console.error('[auth] attach error', e); }
      // flush any pending logs collected while offline/anonymous
      try{ flushPendingLogs(); } catch(e){ /* ignore */ }
      // show migrate/clear buttons
      try { document.getElementById('migrateLocalBtn').style.display = 'inline-block'; document.getElementById('clearLocalBtn').style.display = 'inline-block'; } catch(e){}
      // update account popup UI
      try{
        if(apName) apName.textContent = user.displayName || user.email || 'Kullanıcı';
        if(apStatus) apStatus.textContent = 'Hesabınıza giriş yapıldı';
        if(apAvatar) apAvatar.innerHTML = user.photoURL ? `<img src="${user.photoURL}" style="width:100%;height:100%;object-fit:cover">` : '<i class="fas fa-user"></i>';
      }catch(e){console.error(e);}
      // show/hide action buttons consistently
      try{ setAccountPopupButtons(true); }catch(e){console.error(e);}
    } else {
      document.getElementById('userInfo').textContent = 'Giriş yok';
  document.getElementById('userAvatar').innerHTML = '<i class="fas fa-user" style="font-size:1rem"></i>';
      document.getElementById('authBtn').textContent = 'Giriş';
      // detach listener and load local fallback
      dbg('[auth] user signed out, detaching DB listener and loading localStorage fallback');
      try { if(typeof recordsUnsub === 'function') recordsUnsub(); } catch(e){}
      recordsRef = null; recordsUnsub = null;
      try {
        const local = localStorage.getItem('hesapkitap_records_v2');
        if(local){ records = JSON.parse(local); window.records = records; renderRecords(); dbg('[auth] loaded', records.length, 'records from localStorage'); }
        else { records = []; window.records = records; renderRecords(); }
      } catch(e){ records = []; window.records = records; renderRecords(); }
      // hide migrate/clear buttons when signed out
      try { document.getElementById('migrateLocalBtn').style.display = 'none'; document.getElementById('clearLocalBtn').style.display = 'none'; } catch(e){}
      // update account popup UI for signed-out state
      try{
        if(apName) apName.textContent = 'Giriş yok';
        if(apStatus) apStatus.textContent = 'Henüz giriş yapılmadı';
        if(apAvatar) apAvatar.innerHTML = '<i class="fas fa-user"></i>';
      }catch(e){console.error(e);}
      // show/hide action buttons consistently
      try{ setAccountPopupButtons(false); }catch(e){console.error(e);}
    }
  });

  // migrate localStorage backup to current user's DB
  (function(){
    const migrateBtn = document.getElementById('migrateLocalBtn');
    const clearBtn = document.getElementById('clearLocalBtn');
    if(migrateBtn){
      migrateBtn.addEventListener('click', async () => {
        if(!currentUser) return alert('Önce giriş yapın');
        if(!confirm('Yerel yedek veriyi kullanıcı hesabınıza taşımak istiyor musunuz? (Geri alınamaz)')) return;
        try {
          dbg('[migrate] currentUser=', currentUser && currentUser.uid);
          const local = localStorage.getItem('hesapkitap_records_v2');
          if(!local) return alert('Yerel yedek bulunamadı');
          const arr = JSON.parse(local);
          const obj = {};
          for(const r of arr) obj[r.id || (Date.now()+Math.random())] = r;
          const userRef = ref(db, `users/${currentUser.uid}/records`);
          await set(userRef, obj);
          dbg('[migrate] set ok to', `users/${currentUser.uid}/records`);
          alert('Yerel veriler hesabınıza taşındı.');
        } catch(e){ console.error('[migrate] migrate error', e); alert('Taşıma sırasında hata: ' + (e && e.message)); }
      });
    }
    if(clearBtn){
      clearBtn.addEventListener('click', () => {
        if(!confirm('Yerel yedeği silmek istediğinize emin misiniz? Bu işlem geri alınamaz.')) return;
        try { localStorage.removeItem('hesapkitap_records_v2'); alert('Yerel yedek silindi'); } catch(e){ console.error(e); alert('Silme başarısız'); }
      });
    }
  })();

  // expose helper for debugging (recordsRef may be null until sign-in)
  window.__fb = { app, auth, db, get recordsRef(){ return recordsRef; }, sharedMsgRef };
/* ---------------------------
  APP LOGIC
----------------------------*/

/* ---- Firebase imports will be in module script below; keep app logic separate until DB ready --- */

let records = [];           // data (mirrored from firebase)
// Toggle verbose logging during debugging. Set to true only when needed.
const DEBUG = false;
function dbg(...args){ if(DEBUG) console.log(...args); }
let editingId = null;
let currentUser = null;

/* DOM */
const balanceValueEl = document.getElementById('balanceValue');
const percentBadge = document.getElementById('percentBadge');
const metaSub = document.getElementById('metaSub');
const recordsEl = document.getElementById('records');

const d_amount = document.getElementById('d_amount');
const d_note = document.getElementById('d_note');
const d_tags = document.getElementById('d_tags');
const d_date = document.getElementById('d_date');
const d_save = document.getElementById('d_save');
const d_close = document.getElementById('d_close');

const openAddBtn = document.getElementById('openAdd');
const floatingAdd = document.getElementById('floatingAdd');

const filterAll = document.getElementById('filterAll');
const filterIncome = document.getElementById('filterIncome');
const filterExpense = document.getElementById('filterExpense');
const searchNote = document.getElementById('searchNote');

const chartWrap = document.getElementById('chartWrap');
const chartPreview = document.getElementById('chartPreview');

const advBtn = document.getElementById('advancedSearchBtn');
const advModal = document.getElementById('advancedSearchModal');
const advContent = document.getElementById('advancedSearchContent');
const advClose = document.getElementById('adv_close');
const advApply = document.getElementById('adv_apply');

const authBtn = document.getElementById('authBtn');
const userInfo = document.getElementById('userInfo');
const userAvatar = document.getElementById('userAvatar');

// Balance full-value hover tooltip (desktop only)
(function(){
  try{
    // don't enable on touch devices
    if(('ontouchstart' in window) || window.matchMedia && window.matchMedia('(pointer:coarse)').matches) return;
    const el = document.getElementById('balanceValue');
    if(!el) return;
    let tip = document.getElementById('balanceFullTooltip');
    if(!tip){
      tip = document.createElement('div');
      tip.id = 'balanceFullTooltip';
      tip.style.position = 'fixed';
      tip.style.pointerEvents = 'none';
      tip.style.background = 'var(--card)';
      tip.style.color = 'var(--muted)';
      tip.style.border = '1px solid var(--border)';
      tip.style.padding = '6px 8px';
      tip.style.borderRadius = '6px';
      tip.style.boxShadow = '0 8px 30px rgba(0,0,0,0.12)';
      tip.style.zIndex = 3000;
      tip.style.display = 'none';
      document.body.appendChild(tip);
    }

    function showFull(evt){
      const full = el.title || el.getAttribute('data-full') || el.textContent || '';
      tip.textContent = full;
      tip.style.left = (evt.clientX + 12) + 'px';
      tip.style.top = (evt.clientY + 12) + 'px';
      tip.style.display = 'block';
    }
    function moveFull(evt){
      tip.style.left = (evt.clientX + 12) + 'px';
      tip.style.top = (evt.clientY + 12) + 'px';
    }
    function hideFull(){ tip.style.display = 'none'; }

    el.addEventListener('mouseenter', showFull);
    el.addEventListener('mousemove', moveFull);
    el.addEventListener('mouseleave', hideFull);
  }catch(e){ /* ignore */ }
})();

// Mobile: tapping balance opens numeric search modal (only on touch devices)
(function(){
  try{
    if(!('ontouchstart' in window) && !(window.matchMedia && window.matchMedia('(pointer:coarse)').matches)) return;
    const el = document.getElementById('balanceValue');
    const modal = document.getElementById('balanceSearchModal');
    const input = document.getElementById('balanceSearchInput');
    const cancel = document.getElementById('balanceSearchCancel');
    const ok = document.getElementById('balanceSearchOk');
    if(!el || !modal || !input) return;
    function open(){ modal.style.display='flex'; modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); input.focus(); }
    function close(){ modal.classList.remove('show'); modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
    el.addEventListener('click', (e)=>{ e.preventDefault(); open(); });
    if(cancel) cancel.addEventListener('click', ()=> close());
    if(ok) ok.addEventListener('click', ()=>{
      const v = parseFloat(input.value);
      if(!isNaN(v)){
        // filter records by approx amount: show records with amount equal to v (exact) or within small tolerance
        advancedFilters = { minAmt: v, maxAmt: v, startDate:null, endDate:null, tagQuery: [] };
        renderRecords();
      }
      close();
    });
  }catch(e){}
})();

/* Mobile bottom nav wiring (exists only on small screens) */
const navHome = document.getElementById('navHome');
const navSearch = document.getElementById('navSearch');
const navAdd = document.getElementById('navAdd');
const navShared = document.getElementById('navShared');
const navAccount = document.getElementById('navAccount');

// Quick jump button (desktop): scroll to analysis chart
const gotoChartBtn = document.getElementById('gotoChartBtn');
if(gotoChartBtn) gotoChartBtn.addEventListener('click', (e) => {
  e.preventDefault();
  // prefer the main analysis canvas; fallback to summary or wrapper
  const target = document.getElementById('analysisChart') || document.getElementById('summaryChart') || document.getElementById('chartWrap');
  if(!target) {
    // ensure charts are built then scroll
    updateChartsForView();
    setTimeout(()=> { const t = document.getElementById('analysisChart') || document.getElementById('summaryChart') || document.getElementById('chartWrap'); if(t) { t.scrollIntoView({ behavior: 'smooth', block: 'center' }); try{ t.focus(); }catch(e){} } }, 420);
    return;
  }
  target.scrollIntoView({ behavior: 'smooth', block: 'center' });
  setTimeout(()=> { try{ target.focus(); } catch(e){} }, 420);
});

if(navAdd) navAdd.addEventListener('click', (e)=> { e.preventDefault(); openAdd(); });
if(navSearch) navSearch.addEventListener('click', (e)=> { e.preventDefault(); openAdvModal(); });
// navAccount should only open the account popup (no sign-in/out)
if(navAccount) navAccount.addEventListener('click', (e)=> { e.preventDefault(); toggleAccountPopup(); });
if(navHome) navHome.addEventListener('click', (e)=> { e.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' }); });
// navShared now focuses the analysis chart (summaryChart)
if(navShared) navShared.addEventListener('click', (e)=> { e.preventDefault();
  const chartCanvas = document.getElementById('summaryChart');
  if(chartCanvas){
    chartCanvas.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(()=> { try{ chartCanvas.focus(); } catch(e){} }, 380);
  } else {
    updateChartsForView();
    setTimeout(()=> { const c = document.getElementById('summaryChart'); if(c){ c.scrollIntoView({ behavior:'smooth', block:'center' }); try{ c.focus(); } catch(e){} } }, 420);
  }
});

/* Account popup wiring (toggle + actions) */
const accountPopup = document.getElementById('accountPopup');
const apMigrate = document.getElementById('apMigrate');
const apClear = document.getElementById('apClear');
const apExport = document.getElementById('apExport');
const apSignOut = document.getElementById('apSignOut');
const apName = document.getElementById('apName');
const apStatus = document.getElementById('apStatus');
const apAvatar = document.getElementById('apAvatar');

function toggleAccountPopup(show){
  if(!accountPopup) return;
  const willOpen = (typeof show === 'boolean') ? show : !accountPopup.classList.contains('open');
  if(willOpen){
    accountPopup.classList.add('open');
    accountPopup.setAttribute('aria-hidden','false');
  } else {
    accountPopup.classList.remove('open');
    accountPopup.setAttribute('aria-hidden','true');
  }
}

if(userAvatar) userAvatar.addEventListener('click', ()=> toggleAccountPopup());
// navAccount is already wired above to open the popup without triggering auth

if(apMigrate) apMigrate.addEventListener('click', ()=> { const b=document.getElementById('migrateLocalBtn'); if(b) b.click(); toggleAccountPopup(false); });
if(apClear) apClear.addEventListener('click', ()=> { const b=document.getElementById('clearLocalBtn'); if(b) b.click(); toggleAccountPopup(false); });
if(apExport) apExport.addEventListener('click', ()=> {
  try{
    const data = JSON.stringify(records || [], null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'para_takip_records.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }catch(e){ console.error('export error', e); alert('Dışa aktarma başarısız'); }
  toggleAccountPopup(false);
});
// Import handler: open file picker, parse JSON, validate and merge/replace into DB or localStorage
const apImportBtn = document.getElementById('apImport');
const importFileInput = document.getElementById('importFile');
if(apImportBtn && importFileInput){
  apImportBtn.addEventListener('click', ()=> importFileInput.click());
  importFileInput.addEventListener('change', (ev)=>{
    const f = ev.target.files && ev.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = async (e)=>{
      try{
        const txt = e.target.result;
        const parsed = JSON.parse(txt);
        if(!Array.isArray(parsed)) return alert('Geçersiz dosya formatı: beklenen dizi');
        // normalize records
        const imported = parsed.map(r=>({
          id: r.id || String(Date.now() + Math.floor(Math.random()*9999)),
          amount: Number(r.amount || r.tutar || 0),
          type: (r.type === 'income' || r.type === 'expense') ? r.type : (Number(r.amount) >= 0 ? 'income' : 'expense'),
          note: r.note || r.not || '(not yok)',
          tags: Array.isArray(r.tags) ? r.tags : (r.tags ? String(r.tags).split(',').map(t=>t.trim()).filter(Boolean) : []),
          date: r.date || new Date().toISOString().slice(0,10)
        }));

        // ask user whether replace or merge
        const choice = confirm('Veriyi birleştirmek için OK, mevcut veriyi tamamen değiştirmek için Cancel tuşlayın. (OK = merge, Cancel = replace)');

        if(currentUser && recordsRef){
          // write to user's DB
          if(choice){
            // merge: combine with existing records array
            const existing = records || [];
            // ensure no id collisions
            const map = {};
            for(const ex of existing) map[ex.id] = ex;
            for(const im of imported) map[im.id] = im; // imported overwrites on conflict
            const obj = {};
            for(const k of Object.keys(map)) obj[k] = map[k];
            await set(recordsRef, obj);
            alert('Veri birleştirildi ve hesabınıza kaydedildi.');
          } else {
            // replace
            const obj = {};
            for(const r of imported) obj[r.id] = r;
            const userRef = ref(db, `users/${currentUser.uid}/records`);
            await set(userRef, obj);
            alert('Hesabınızın verisi başarıyla değiştirildi.');
          }
        } else {
          // not signed in -> use localStorage
          if(choice){
            const existing = JSON.parse(localStorage.getItem('hesapkitap_records_v2') || '[]');
            const map = {};
            for(const ex of existing) map[ex.id] = ex;
            for(const im of imported) map[im.id] = im;
            const out = Object.keys(map).map(k=>map[k]);
            localStorage.setItem('hesapkitap_records_v2', JSON.stringify(out));
            alert('Yerel veriye birleştirme yapıldı.');
          } else {
            localStorage.setItem('hesapkitap_records_v2', JSON.stringify(imported));
            alert('Yerel yedek başarıyla değiştirildi.');
          }
        }

        // refresh UI
        try{ if(currentUser){ attachRecordsListenerForUser(currentUser.uid); } else { records = JSON.parse(localStorage.getItem('hesapkitap_records_v2') || '[]'); renderRecords(); } }catch(e){}
      }catch(err){ console.error('import error', err); alert('İçe aktarma sırasında hata: ' + (err && err.message)); }
      // clear input
      importFileInput.value = '';
      toggleAccountPopup(false);
    };
    reader.readAsText(f);
  });
}
if(apSignOut) apSignOut.addEventListener('click', ()=> { toggleAccountPopup(false); const b=document.getElementById('authBtn'); if(b) b.click(); });
const apSignIn = document.getElementById('apSignIn');
if(apSignIn) apSignIn.addEventListener('click', ()=> { toggleAccountPopup(false); const b=document.getElementById('authBtn'); if(b) b.click(); });

// initialize popup button visibility immediately based on current auth state
try{
  // ensure popup closed initially
  accountPopup.classList.remove('open');
  accountPopup.setAttribute('aria-hidden','true');
  // apply correct button visibility
  if(typeof setAccountPopupButtons === 'function') setAccountPopupButtons(!!(auth && auth.currentUser));
}catch(e){/* ignore */}

// Helper: show only the appropriate actions in the account popup depending on sign-in state
function setAccountPopupButtons(signedIn){
  // signedIn === true  => hide apSignIn, show apSignOut + migrate/clear/export
  // signedIn === false => show only apSignIn (hide others)
  try{
    if(signedIn){
      if(apSignIn) apSignIn.style.display = 'none';
      if(apSignOut) apSignOut.style.display = 'inline-flex';
      if(apMigrate) apMigrate.style.display = 'inline-flex';
      if(apClear) apClear.style.display = 'inline-flex';
      if(apExport) apExport.style.display = 'inline-flex';
    } else {
      if(apSignIn) apSignIn.style.display = 'inline-flex';
      if(apSignOut) apSignOut.style.display = 'none';
      if(apMigrate) apMigrate.style.display = 'none';
      if(apClear) apClear.style.display = 'none';
      if(apExport) apExport.style.display = 'none';
    }
  }catch(e){ console.error('[setAccountPopupButtons]', e); }
}

// Close popup when clicking outside (but ignore clicks on avatar and the mobile account nav button)
document.addEventListener('click', (ev) => {
  try{
    const open = accountPopup && accountPopup.classList.contains('open');
    if(!open) return;
    const path = ev.composedPath ? ev.composedPath() : (ev.path || []);
    if(path && path.indexOf(accountPopup) > -1) return; // click inside popup
    if(path && path.indexOf(userAvatar) > -1) return; // click on avatar toggles explicitly
    // also ignore clicks on the bottom-nav account button so it can open the popup
    if(typeof navAccount !== 'undefined' && navAccount && path && path.indexOf(navAccount) > -1) return;
    // otherwise close
    toggleAccountPopup(false);
  }catch(e){/* ignore */}
});



/* Chart instances */
let mainChart = null;
let previewChart = null;
let summaryChart = null;

/* Theme init: prefer device, but allow override */
function initTheme() {
  const stored = localStorage.getItem('paraTakip_theme');
  if (stored === 'dark') document.body.classList.add('dark');
  else if (stored === 'light') document.body.classList.remove('dark');
  else {
    // follow device preference
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.body.classList.add('dark');
  }
}
initTheme();

document.getElementById('themeToggle').addEventListener('click', () => {
  document.body.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  localStorage.setItem('paraTakip_theme', isDark ? 'dark' : 'light');
});

/* Utility: format TL amount */
function formatTLNumber(n){
  return Number(n).toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2});
}

/* Animate balance */
let animateFrame = null;
let displayedBalance = null;
function animateBalanceTo(target){
  if(animateFrame) cancelAnimationFrame(animateFrame);
  const start = displayedBalance === null ? target : displayedBalance;
  const duration = 600;
  const startTime = performance.now();
  function step(now){
    const t = Math.min(1, (now - startTime)/duration);
    const eased = t<.5 ? 2*t*t : -1 + (4 - 2*t)*t;
    const cur = start + (target - start) * eased;
    // cur is in currently-selected currency when Animate is invoked with convertedTotal
    const currency = (document.getElementById('currencySelect') && document.getElementById('currencySelect').value) || 'TRY';
    // display full or compact depending on available space
    try{ displayBalance(cur, currency); } catch(e){
      // fallback: compact
      try{ balanceValueEl.textContent = formatCompactConverted(cur, currency); balanceValueEl.title = formatConverted(cur, currency); }catch(e){}
    }
    if(t < 1) animateFrame = requestAnimationFrame(step);
    else { displayedBalance = target; animateFrame = null; }
  }
  animateFrame = requestAnimationFrame(step);
  balanceValueEl.classList.add('updated');
  setTimeout(()=> balanceValueEl.classList.remove('updated'), 220);
}

// Helper: get current currency selection
function getCurrentCurrency(){ return (document.getElementById('currencySelect') && document.getElementById('currencySelect').value) || 'TRY'; }

// Numeric-only variants used for the prominent balance display (no currency symbol)
function formatConvertedNumeric(amount, currency) {
  const num = (typeof amount === 'number' && isFinite(amount)) ? amount : Number(amount);
  const safe = isFinite(num) ? num : 0;
  switch(currency) {
    case 'TRY':
      return formatTLNumber(safe);
    case 'USD':
    case 'EUR':
      return safe.toFixed(2);
    case 'GLD_Q':
    case 'GLD_F':
    case 'GLD_G':
      return safe.toFixed(4);
    case 'BTC':
      return safe.toFixed(6);
    default:
      return formatTLNumber(safe);
  }
}

function formatCompactConvertedNumeric(amount, currency) {
  const num = (typeof amount === 'number' && isFinite(amount)) ? amount : Number(amount);
  const safe = isFinite(num) ? num : 0;
  const abs = Math.abs(safe);
  function fmt(n){
    const s = (Math.round(n * 1000) / 1000).toString().replace('.', ',');
    return s;
  }
  if(abs >= 1e9) return fmt(safe / 1e9) + 'B';
  if(abs >= 1e6) return fmt(safe / 1e6) + 'M';
  if(abs >= 1e3) return fmt(safe / 1e3) + 'K';
  return formatConvertedNumeric(safe, currency);
}

// Display balance: show numeric-only visible text (no symbol), use full formatted value in tooltip/title.
function displayBalance(amount, currency){
  try{
    if(!balanceValueEl) return;
    // full (with symbol) for tooltip/title, numeric-only for visible text
    const full = formatConverted(amount, currency);
    const fullNumeric = formatConvertedNumeric(amount, currency);
    const compact = formatCompactConverted(amount, currency);
    const compactNumeric = formatCompactConvertedNumeric(amount, currency);

    // put full text first so we can measure whether it overflows
    balanceValueEl.style.whiteSpace = 'nowrap';
    // restore original font-size if we stored it earlier
    try{
      if(!balanceValueEl.dataset.origFontSize){
        const cs = window.getComputedStyle(balanceValueEl);
        balanceValueEl.dataset.origFontSize = cs.fontSize || '';
      }
    }catch(e){}
    // reset style to original
    balanceValueEl.style.fontSize = balanceValueEl.dataset.origFontSize || '';

    // visible numeric-only text
    balanceValueEl.textContent = fullNumeric;
    balanceValueEl.setAttribute('data-full', full);
    try{ balanceValueEl.title = full; } catch(e){}

    // compute available width inside the balance-amount
    const parent = balanceValueEl.parentElement; // .balance-amount
    let available = null;
    try{
      if(parent){
        const parentStyle = window.getComputedStyle(parent);
        const gap = parseFloat(parentStyle.columnGap || parentStyle.gap || 8) || 8;
        // currency badge is outside the inline area, so use full parent width
        available = parent.clientWidth - 4; // small padding buffer
      }
    }catch(e){ available = null; }

    // First: set font-size based on amount magnitude (prefer shrinking by numeric size)
    try{
      const orig = balanceValueEl.dataset.origFontSize ? parseFloat(balanceValueEl.dataset.origFontSize) : (parseFloat(window.getComputedStyle(balanceValueEl).fontSize) || 28);
      let scale = 1;
      const absAmt = Math.abs(Number(amount) || 0);
      if(absAmt >= 1e9) scale = 0.55;       // >= 1B
      else if(absAmt >= 1e6) scale = 0.7;    // >= 1M
      else if(absAmt >= 1e3) scale = 0.85;   // >= 1K
      else scale = 1;
      const desiredPx = Math.max(10, Math.round(orig * scale));
      balanceValueEl.style.fontSize = desiredPx + 'px';
    }catch(e){ /* ignore sizing errors */ }

    // If it now fits, we're done
    const fitsNow = (available !== null) ? (balanceValueEl.scrollWidth <= available) : (balanceValueEl.scrollWidth <= balanceValueEl.clientWidth);
    if(fitsNow) return;

    // Otherwise, try progressively shrinking until it fits (as a safety fallback)
    try{
      const cs = window.getComputedStyle(balanceValueEl);
      let curPx = parseFloat(cs.fontSize) || 0;
      const minPx = Math.max(10, (parseFloat(balanceValueEl.dataset.origFontSize || curPx) * 0.55));
      let iterations = 0;
      let fitted = false;
      while(curPx > minPx && iterations < 40){
        curPx = Math.max(minPx, Math.floor(curPx - 1));
        balanceValueEl.style.fontSize = curPx + 'px';
        const sw = balanceValueEl.scrollWidth;
        const shouldFit = (available !== null) ? (sw <= available) : (sw <= balanceValueEl.clientWidth);
        if(shouldFit){ fitted = true; break; }
        iterations++;
      }
      if(fitted) return;
    }catch(e){ /* continue to fallback */ }

    // fallback: show compact representation (numeric-only) and restore original font-size
    try{ balanceValueEl.style.fontSize = balanceValueEl.dataset.origFontSize || ''; }catch(e){}
    balanceValueEl.textContent = compactNumeric || compact;
  }catch(e){ /* ignore */ }
}

// Re-evaluate balance display on resize so compact/full toggles appropriately
window.addEventListener('resize', function(){
  try{
    if(typeof displayedBalance !== 'undefined' && displayedBalance !== null){
      displayBalance(displayedBalance, getCurrentCurrency());
    }
  }catch(e){}
});

/* Build tag order */
function getAllTags(){
  const seenLower = new Set();
  const ordered = [];
  for(const r of records){
    if(!r.tags) continue;
    for(const t of r.tags){
      const low = (t||'').toLowerCase();
      if(!seenLower.has(low)){
        seenLower.add(low);
        ordered.push(t);
      }
    }
  }
  return ordered;
}

/* Filter pipeline (includes advanced filters stored in UI when applied) */
let advancedFilters = null; // set by advanced search apply
function getFilteredRecords(){
  let out = records.slice();

  // type
  if(filterIncome.classList.contains('active')) out = out.filter(r=> r.type === 'income');
  if(filterExpense.classList.contains('active')) out = out.filter(r=> r.type === 'expense');

  // search by note
  const q = (searchNote.value || '').trim().toLowerCase();
  if(q) out = out.filter(r => (r.note || '').toLowerCase().includes(q));

  // advanced filters
  if(advancedFilters){
    const {minAmt, maxAmt, startDate, endDate, tagQuery} = advancedFilters;
    out = out.filter(r=>{
      if(!isNaN(minAmt) && r.amount < minAmt) return false;
      if(!isNaN(maxAmt) && r.amount > maxAmt) return false;
      if(startDate && r.date < startDate) return false;
      if(endDate && r.date > endDate) return false;
      if(tagQuery.length && (!r.tags || !tagQuery.every(tq => r.tags.map(tt=>tt.toLowerCase()).includes(tq)))) return false;
      return true;
    });
  }

  // default sort: newest first
  out.sort((a,b) => b.date.localeCompare(a.date) || b.id - a.id);
  return out;
}

/* Update charts from current filtered view (so search updates chart) */
function updateChartsForView(range, mode){
  // Cleanup existing charts first
  destroyAllCharts();
  
  // range: 'weekly'|'monthly'|'yearly'|'all' (optional, defaults to 'all')
  range = range || 'all';
  mode = mode || 'period'; // 'period' (daily buckets) or 'per' (per-transaction)
  const view = getFilteredRecords();
  const income = view.filter(r=>r.type==='income').reduce((s,r)=>s+r.amount,0);
  const expense = view.filter(r=>r.type==='expense').reduce((s,r)=>s+r.amount,0);
  const total = income - expense;
  const percent = (income+expense) === 0 ? 0 : Math.round((income/(income+expense))*100);

  // percent badge text
  percentBadge.textContent = `${percent}% gelir`;

  // small preview chart (doughnut)
  if(previewChart) {
    previewChart.destroy();
    previewChart = null;
  }
  if(!chartPreview) return; // Exit if element doesn't exist
  previewChart = new Chart(chartPreview.getContext ? chartPreview.getContext('2d') : (function(){ 
    chartPreview.innerHTML = '<canvas id="miniChart"></canvas>'; 
    return document.getElementById('miniChart').getContext('2d');
  })(), {
    type:'doughnut',
    data:{ labels:['Gelir','Gider'], datasets:[{ data:[income, expense], backgroundColor:['#00c853','#ff5252'] }]},
    options:{plugins:{legend:{display:false}}, maintainAspectRatio:false}
  });

  // summary doughnut + analysis line chart container
  if(mainChart) mainChart.destroy();
  // preserve controls state (colors for increase/decrease, smoothing, mode) across re-renders
  const prevColorIncEl = document.getElementById('chartColorInc');
  const prevColorDecEl = document.getElementById('chartColorDec');
  // Preserve previous color values if controls existed, otherwise use defaults
  let prevColorInc = (prevColorIncEl && prevColorIncEl.value) ? prevColorIncEl.value : '#19be24';
  let prevColorDec = (prevColorDecEl && prevColorDecEl.value) ? prevColorDecEl.value : '#ef5350';
  const prevSmoothingEl = document.getElementById('smoothingToggle');
  let prevSmoothing = prevSmoothingEl ? prevSmoothingEl.value : 'sharp';
  const prevModeBtn = document.querySelector('#analysisMode [data-mode].active');
  const prevMode = prevModeBtn ? prevModeBtn.getAttribute('data-mode') : (mode || 'period');
  // ensure we use previous mode as starting currentMode
  let currentMode = prevMode || mode || 'period';

  // preserve current currency selection if the controls were already rendered
  const currentCurrencyEl = document.getElementById('currencySelect');
  const currentCurrency = currentCurrencyEl ? currentCurrencyEl.value : 'TRY';
  // preserve previously-entered settings so they don't reset when we rebuild the DOM
  const prevHeightEl = document.getElementById('chartHeight');
  const prevYMinEl = document.getElementById('chartYMin');
  const prevYMaxEl = document.getElementById('chartYMax');
  let prevChartHeight = prevHeightEl ? prevHeightEl.value : '200';
  let prevYMin = prevYMinEl ? prevYMinEl.value : '';
  let prevYMax = prevYMaxEl ? prevYMaxEl.value : '';
  // preserve previously-selected graph style (classic|bitcoin)
  const prevGraphStyleEl = document.querySelector('#chartGraphStyle [data-graph].active');
  let prevGraphStyle = prevGraphStyleEl ? prevGraphStyleEl.getAttribute('data-graph') : 'classic';
  // preserve whether settings panel was open so re-renders don't close it
  const prevSettingsEl = document.getElementById('chartSettings');
  let prevIsOpen = prevSettingsEl ? prevSettingsEl.classList.contains('open') : false;

  try {} catch(e){}

  // If there are saved preferences (saved just before calling update), prefer them
  try{
    const saved = JSON.parse(localStorage.getItem('chartPreferences') || '{}');
    if(saved){
      if(saved.colorInc) prevColorInc = saved.colorInc;
      if(saved.colorDec) prevColorDec = saved.colorDec;
      if(saved.smoothing) prevSmoothing = saved.smoothing;
      if(saved.height) prevChartHeight = saved.height;
      if(typeof saved.yMin !== 'undefined') prevYMin = saved.yMin || '';
      if(typeof saved.yMax !== 'undefined') prevYMax = saved.yMax || '';
      if(saved.graphStyle) prevGraphStyle = saved.graphStyle;
      if(typeof saved.isOpen !== 'undefined') prevIsOpen = !!saved.isOpen;
    }
  }catch(e){ /* ignore parse errors */ }

  // Determine whether these settings controls existed before (used to avoid re-applying saved prefs on every re-render)
  const isInitialSettingsRender = !(prevColorIncEl || prevSmoothingEl || prevGraphStyleEl);

  chartWrap.innerHTML = `
    <div class="analysis-area">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <strong>Analiz: Bakiye Zaman Serisi</strong>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div class="analysis-range" role="tablist" aria-label="Zaman aralığı">
            <button class="btn btn-sm btn-outline-secondary" data-range="weekly">1 Hafta</button>
            <button class="btn btn-sm btn-outline-secondary" data-range="monthly">1 Ay</button>
            <button class="btn btn-sm btn-outline-secondary" data-range="yearly">1 Yıl</button>
            <button class="btn btn-sm btn-outline-secondary" data-range="all">Tüm Zaman</button>
          </div>

          <div style="display:flex;gap:6px;align-items:center">
            <label style="font-size:0.85rem; margin-right:6px">Mod:</label>
            <div id="analysisMode" style="display:flex;gap:6px">
              <button class="btn btn-sm btn-outline-secondary" data-mode="period">Günlük</button>
              <button class="btn btn-sm btn-outline-secondary" data-mode="per">İşlem</button>
            </div>
          </div>
          
          <div style="display:flex;gap:6px;align-items:center">
            <label style="font-size:0.85rem">Grafik Tipi:</label>
            <div id="chartGraphStyle" style="display:flex;gap:6px">
              <button class="btn btn-sm btn-outline-secondary ${prevGraphStyle === 'classic' ? 'active' : ''}" data-graph="classic">Klasik</button>
              <button class="btn btn-sm btn-outline-secondary ${prevGraphStyle === 'bitcoin' ? 'active' : ''}" data-graph="bitcoin">Mum</button>
            </div>
          </div>

          <div style="display:flex;gap:6px;align-items:center">
            <label style="font-size:0.85rem">Para Birimi:</label>
            <select id="currencySelect" class="form-select form-select-sm" style="width:auto; min-width:150px" onchange="handleCurrencyChange(this.value)">
              <option value="TRY" ${currentCurrency === 'TRY' ? 'selected' : ''}>Türk Lirası (₺)</option>
              <option value="USD" ${currentCurrency === 'USD' ? 'selected' : ''}>Amerikan Doları ($)</option>
              <option value="EUR" ${currentCurrency === 'EUR' ? 'selected' : ''}>Euro (€)</option>
              <option value="GLD_Q" ${currentCurrency === 'GLD_Q' ? 'selected' : ''}>Çeyrek Altın</option>
              <option value="GLD_F" ${currentCurrency === 'GLD_F' ? 'selected' : ''}>Tam Altın</option>
              <option value="GLD_G" ${currentCurrency === 'GLD_G' ? 'selected' : ''}>Gram Altın (gr)</option>
              <option value="BTC" ${currentCurrency === 'BTC' ? 'selected' : ''}>Bitcoin (₿)</option>
            </select>
          </div>

          <div class="chart-settings-container">
            <button id="chartSettingsToggle" class="btn btn-sm btn-outline-secondary collapsible-btn ${prevIsOpen ? 'active' : ''}">
              <span>Grafik Ayarları</span>
              <i class="fas fa-chevron-down"></i>
            </button>
            <div id="chartSettings" class="collapsible-content ${prevIsOpen ? 'open' : ''}">
              <div class="settings-grid">
                <div class="settings-item">
                  <label style="font-size:0.85rem">Çizgi Tipi:</label>
                  <select id="smoothingToggle" class="form-select form-select-sm">
                    <option value="sharp" ${prevSmoothing === 'sharp' ? 'selected' : ''}>Keskin</option>
                    <option value="smooth" ${prevSmoothing === 'smooth' ? 'selected' : ''}>Yumuşak</option>
                  </select>
                </div>
                <div class="settings-item">
                  <label style="font-size:0.85rem">Artış Rengi:</label>
                  <input id="chartColorInc" type="color" value="${prevColorInc}" title="Bakiye artma rengi">
                </div>
                <div class="settings-item">
                  <label style="font-size:0.85rem">Azalış Rengi:</label>
                  <input id="chartColorDec" type="color" value="${prevColorDec}" title="Bakiye azalma rengi">
                </div>
                <div class="settings-item">
                  <label style="font-size:0.85rem">Grafik Yüksekliği (px):</label>
                  <input id="chartHeight" type="number" class="form-control form-control-sm" value="${prevChartHeight}" min="100" max="800" step="50" style="color:#e8e8e8; background:#131722">
                </div>
                <div class="settings-item">
                  <label style="font-size:0.85rem">Y Ekseni Min:</label>
                  <input id="chartYMin" type="number" class="form-control form-control-sm" placeholder="Otomatik" value="${prevYMin}" style="color:#e8e8e8; background:#131722">
                </div>
                <div class="settings-item">
                  <label style="font-size:0.85rem">Y Ekseni Max:</label>
                  <input id="chartYMax" type="number" class="form-control form-control-sm" placeholder="Otomatik" value="${prevYMax}" style="color:#e8e8e8; background:#131722">
                </div>
              </div>
              
            </div>
          </div>
          
        </div>
      </div>
      <div style="margin-top:8px"><canvas id="analysisChart" height="140" tabindex="0" aria-label="Bakiye zaman serisi grafiği"></canvas></div>
    </div>
    <div style="margin-top:10px"><canvas id="summaryChart" height="160" tabindex="0" aria-label="Gelir gider özeti"></canvas></div>
    <div style="margin-top:8px; text-align:center">
      <button id="chartScrollUpBtn" class="btn btn-sm btn-outline-secondary" title="Yukarı Çık"><i class="fas fa-arrow-up"></i> Yukarı Çık</button>
    </div>
  `;

  // wire range buttons
  const rangeBtns = chartWrap.querySelectorAll('.analysis-range .btn');
  rangeBtns.forEach(b => {
    b.classList.toggle('active', b.getAttribute('data-range') === range);
    b.addEventListener('click', ()=> { console.log('range clicked', b.getAttribute('data-range')); updateChartsForView(b.getAttribute('data-range'), currentMode); });
  });

  // wire mode buttons
  const modeBtns = chartWrap.querySelectorAll('#analysisMode [data-mode]');
  modeBtns.forEach(mb => {
    mb.classList.toggle('active', mb.getAttribute('data-mode') === currentMode);
    mb.addEventListener('click', ()=> {
      currentMode = mb.getAttribute('data-mode');
      console.log('mode changed', currentMode);
      modeBtns.forEach(x=>x.classList.remove('active'));
      mb.classList.add('active');
      updateChartsForView(range, currentMode);
    });
  });

  // Initialize chart settings after elements are created
  const chartSettingsToggle = document.getElementById('chartSettingsToggle');
  const chartSettings = document.getElementById('chartSettings');
  
  dbg('Chart settings elementleri kontrol ediliyor:', {
    toggleButton: !!chartSettingsToggle,
    settingsPanel: !!chartSettings
  });
  // helper to save current chart preferences to localStorage
  function saveChartPrefs(){
    try{
      const prefs = {
        smoothing: document.getElementById('smoothingToggle')?.value,
        colorInc: document.getElementById('chartColorInc')?.value,
        colorDec: document.getElementById('chartColorDec')?.value,
        height: document.getElementById('chartHeight')?.value,
        yMin: document.getElementById('chartYMin')?.value,
        yMax: document.getElementById('chartYMax')?.value,
        graphStyle: (document.querySelector('#chartGraphStyle [data-graph].active') || {}).getAttribute ? (document.querySelector('#chartGraphStyle [data-graph].active')?.getAttribute('data-graph')) : prevGraphStyle,
        isOpen: chartSettings ? chartSettings.classList.contains('open') : false
      };
      localStorage.setItem('chartPreferences', JSON.stringify(prefs));
      try{ console.log('chartPrefs saved', prefs); } catch(e){}
    }catch(e){ console.error('saveChartPrefs error', e); }
  }
  
    if (chartSettingsToggle && chartSettings) {
    
    // Load saved preferences only on the initial settings render (don't overwrite user's in-session changes)
    try {
      const saved = localStorage.getItem('chartPreferences');
      dbg('localStorage\'dan yüklenen tercihler:', saved);
      
      if (isInitialSettingsRender && saved) {
        const prefs = JSON.parse(saved);
        dbg('Parsed preferences:', prefs);
        
        const smoothingElement = document.getElementById('smoothingToggle');
        const colorIncElement = document.getElementById('chartColorInc');
        const colorDecElement = document.getElementById('chartColorDec');
        const heightElement = document.getElementById('chartHeight');
        const yMinElement = document.getElementById('chartYMin');
        const yMaxElement = document.getElementById('chartYMax');
        const graphStyleContainer = document.getElementById('chartGraphStyle');
        
        dbg('Kontrol elementleri:', {
          smoothingElement: !!smoothingElement,
          colorIncElement: !!colorIncElement,
          colorDecElement: !!colorDecElement
        });
        
        if (prefs.smoothing && smoothingElement) smoothingElement.value = prefs.smoothing;
        if (prefs.colorInc && colorIncElement) colorIncElement.value = prefs.colorInc;
        if (prefs.colorDec && colorDecElement) colorDecElement.value = prefs.colorDec;
        if (typeof prefs.height !== 'undefined' && heightElement) heightElement.value = prefs.height;
        if (typeof prefs.yMin !== 'undefined' && yMinElement) yMinElement.value = prefs.yMin;
        if (typeof prefs.yMax !== 'undefined' && yMaxElement) yMaxElement.value = prefs.yMax;
        if (prefs.graphStyle && graphStyleContainer) {
          const btns = graphStyleContainer.querySelectorAll('[data-graph]');
          btns.forEach(b => b.classList.toggle('active', b.getAttribute('data-graph') === prefs.graphStyle));
        }
        if (prefs.isOpen) {
          chartSettings.classList.add('open');
          chartSettingsToggle.classList.add('active');
        }
      }
    } catch(e) {
      console.error('Error loading chart preferences:', e);
    }
    
    // Wire up the toggle button
    chartSettingsToggle.addEventListener('click', (e) => {
      dbg('Toggle butonuna tıklandı');
      e.preventDefault();
      chartSettings.classList.toggle('open');
      chartSettingsToggle.classList.toggle('active');
      // Save current prefs when toggling
      saveChartPrefs();
    });
  }

  

  // smoothing, color and graph-style controls
  const smoothingEl = document.getElementById('smoothingToggle');
  const colorIncEl = document.getElementById('chartColorInc');
  const colorDecEl = document.getElementById('chartColorDec');
  const graphStyleBtns = chartWrap.querySelectorAll('#chartGraphStyle [data-graph]');
  
  // Wire color and smoothing change handlers
  // (Use updateChartsForView handlers below to keep wiring consistent and avoid duplicate rebuilds)
  // default selection: bitcoin
  if(graphStyleBtns && graphStyleBtns.length){
    const anyActive = Array.from(graphStyleBtns).some(b => b.classList.contains('active'));
    if(!anyActive){ const b = chartWrap.querySelector('#chartGraphStyle [data-graph="bitcoin"]'); if(b) b.classList.add('active'); }
    graphStyleBtns.forEach(b => {
      b.addEventListener('click', ()=> {
        console.log('graph style clicked', b.getAttribute('data-graph'));
        graphStyleBtns.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        // Rebuild chart with current settings
        let series;
        if(currentMode === 'per') series = buildTransactionSeries(view, range);
        else series = buildBalanceSeries(view, range);
        buildCharts(series, range, currentMode);
        // persist graph style selection
        try{ const prefs = JSON.parse(localStorage.getItem('chartPreferences') || '{}'); prefs.graphStyle = b.getAttribute('data-graph'); localStorage.setItem('chartPreferences', JSON.stringify(prefs)); try{ console.log('chartPrefs saved', prefs); }catch(e){} }catch(e){}
      });
    });
  }
  if(smoothingEl) smoothingEl.addEventListener('change', ()=> { console.log('smoothing changed', smoothingEl.value); saveChartPrefs(); updateChartsForView(range, currentMode); });
  if(colorIncEl) colorIncEl.addEventListener('change', ()=> { console.log('colorInc changed', colorIncEl.value); saveChartPrefs(); updateChartsForView(range, currentMode); });
  if(colorDecEl) colorDecEl.addEventListener('change', ()=> { console.log('colorDec changed', colorDecEl.value); saveChartPrefs(); updateChartsForView(range, currentMode); });

  // Height and Y-axis min/max controls should also trigger a chart update
  const heightInput = document.getElementById('chartHeight');
  const yMinEl = document.getElementById('chartYMin');
  const yMaxEl = document.getElementById('chartYMax');
  if(heightInput) heightInput.addEventListener('change', ()=> { console.log('chartHeight changed', heightInput.value); saveChartPrefs(); updateChartsForView(range, currentMode); });
  if(yMinEl) yMinEl.addEventListener('change', ()=> { console.log('chartYMin changed', yMinEl.value); saveChartPrefs(); updateChartsForView(range, currentMode); });
  if(yMaxEl) yMaxEl.addEventListener('change', ()=> { console.log('chartYMax changed', yMaxEl.value); saveChartPrefs(); updateChartsForView(range, currentMode); });

  // Currency handling is now done through handleCurrencyChange function

  // build time-series (cumulative balance) depending on range and mode
  let series;
  if(currentMode === 'per') series = buildTransactionSeries(view, range);
  else series = buildBalanceSeries(view, range);

  // Build charts with current view data
  const chartData = currentMode === 'per' ? buildTransactionSeries(view, range) : buildBalanceSeries(view, range);
  buildCharts(chartData, range, currentMode);
}

// Currency conversion rates (normally these would come from an API)
const currencyRates = {
  TRY: 1,
  USD: 0.036, // 1 TL = 0.036 USD
  EUR: 0.034, // 1 TL = 0.034 EUR
  GLD_Q: 0.00037, // 1 TL = 0.00037 Çeyrek
  GLD_F: 0.000093, // 1 TL = 0.000093 Tam
  GLD_G: 0.00037, // placeholder rate for Gram Altın (adjust as needed)
  BTC: 0.0000012 // 1 TL = 0.0000012 BTC
};

// Handle currency changes — expose globally so inline onchange can call it (script is module-scoped)
window.handleCurrencyChange = function(newCurrency) {
  try{
    dbg('Currency changed to:', newCurrency);
    // Update the bottom-left currency badge
    try{ updateCurrencyBadge(newCurrency); }catch(e){}
    // Force destroy all charts before recreating
    destroyAllCharts();
    // Re-render with current view settings (will re-evaluate balance display)
    updateChartsForView();
  } catch (e) {
    console.error('handleCurrencyChange error', e);
  }
};

const currencySymbols = {
  TRY: '₺',
  USD: '$',
  EUR: '€',
  GLD_Q: 'Çeyrek',
  GLD_F: 'Tam',
  GLD_G: 'gr',
  BTC: '₿'
};

// Update the bottom-left currency badge element
function updateCurrencyBadge(newCurrency){
  try{
    const sel = newCurrency || getCurrentCurrency();
    const el = document.getElementById('currencyBadge');
    if(!el) return;
    el.textContent = currencySymbols[sel] || sel;
    el.setAttribute('aria-label', 'Para birimi: ' + (sel || ''));
    // refresh visible balance formatting
    try{ if(typeof displayedBalance !== 'undefined' && displayedBalance !== null) displayBalance(displayedBalance, sel); } catch(e){}
  }catch(e){ /* ignore */ }
}

// initialize badge on load
try{ updateCurrencyBadge(); }catch(e){}

// Helper function to cleanup all charts
function destroyAllCharts() {
  if(mainChart) {
    mainChart.destroy();
    mainChart = null;
  }
  if(previewChart) {
    previewChart.destroy();
    previewChart = null;
  }
  if(summaryChart) {
    summaryChart.destroy();
    summaryChart = null;
  }
}

// Format currency based on selected type
function formatCurrency(amount, currency) {
  // guard numeric inputs to avoid NaN
  const num = (typeof amount === 'number' && isFinite(amount)) ? amount : Number(amount);
  const converted = (isFinite(num) ? num : 0) * (currencyRates[currency] || 1);
  switch(currency) {
    case 'TRY':
      return formatTLNumber(converted) + ' ₺';
    case 'USD':
      return '$ ' + converted.toFixed(2);
    case 'EUR':
      return '€ ' + converted.toFixed(2);
    case 'GLD_Q':
      return converted.toFixed(4) + ' Çeyrek';
    case 'GLD_F':
      return converted.toFixed(4) + ' Tam';
    case 'BTC':
      return '₿ ' + converted.toFixed(6);
    default:
      return formatTLNumber(converted) + ' ₺';
  }
}

// Format an amount that is already converted to the target currency
function formatConverted(amount, currency) {
  // amount is assumed to be in the target currency already
  const num = (typeof amount === 'number' && isFinite(amount)) ? amount : Number(amount);
  const safe = isFinite(num) ? num : 0;
  switch(currency) {
    case 'TRY':
      return formatTLNumber(safe) + ' ₺';
    case 'USD':
      return '$ ' + safe.toFixed(2);
    case 'EUR':
      return '€ ' + safe.toFixed(2);
    case 'GLD_Q':
      return safe.toFixed(4) + ' Çeyrek';
    case 'GLD_F':
      return safe.toFixed(4) + ' Tam';
    case 'BTC':
      return '₿ ' + safe.toFixed(6);
    default:
      return formatTLNumber(safe) + ' ₺';
  }
}

// Compact formatting for large numbers used in the prominent balance display
function formatCompactConverted(amount, currency) {
  const num = (typeof amount === 'number' && isFinite(amount)) ? amount : Number(amount);
  const safe = isFinite(num) ? num : 0;
  const abs = Math.abs(safe);
  // thresholds: K (1e3), M (1e6), B (1e9)
  function fmt(n){
    // use tr-TR decimal separator for the numeric part
    const s = (Math.round(n * 1000) / 1000).toString().replace('.', ',');
    return s;
  }
  let out;
  if(abs >= 1e9) {
    out = fmt(safe / 1e9) + 'B';
  } else if(abs >= 1e6) {
    out = fmt(safe / 1e6) + 'M';
  } else if(abs >= 1e3) {
    out = fmt(safe / 1e3) + 'K';
  } else {
    // small numbers: use normal formatting
    return formatConverted(safe, currency);
  }
  // append currency symbol (use currencySymbols map where appropriate)
  const sym = currencySymbols[currency] || '';
  // put symbol after number for TRY & GLD variants, before for USD/EUR/BTC
  if(currency === 'TRY' || currency.startsWith('GLD')) return out + ' ' + sym;
  if(currency === 'USD' || currency === 'EUR' || currency === 'BTC') return sym + ' ' + out;
  return out + (sym ? ' ' + sym : '');
}

// Build price chart and volume bars
function buildCharts(series, range, currentMode) {
  try { /* buildCharts invoked (log suppressed per user request) */ } catch(e){}
  const aCtx = document.getElementById('analysisChart').getContext('2d');
  const currencySelect = document.getElementById('currencySelect');
  const selectedCurrency = currencySelect ? currencySelect.value : 'TRY';
  dbg('Building charts with currency:', selectedCurrency);
  
  // Calculate income/expense from current view
  const view = getFilteredRecords();
  const income = view.filter(r=>r.type==='income').reduce((s,r)=>s+r.amount,0);
  const expense = view.filter(r=>r.type==='expense').reduce((s,r)=>s+r.amount,0);
  const total = income - expense;

  // choose colors and smoothing
  const incColor = (document.getElementById('chartColorInc') && document.getElementById('chartColorInc').value) ? document.getElementById('chartColorInc').value : '#26a69a';
  const decColor = (document.getElementById('chartColorDec') && document.getElementById('chartColorDec').value) ? document.getElementById('chartColorDec').value : '#ef5350';
  // which graph style is active? 'classic' or 'bitcoin'
  const graphStyleEl = chartWrap.querySelector('#chartGraphStyle [data-graph].active');
  const graphStyle = graphStyleEl ? graphStyleEl.getAttribute('data-graph') : 'bitcoin';
  const smoothing = (document.getElementById('smoothingToggle') && document.getElementById('smoothingToggle').value === 'smooth');

  // Settings debug: log only settings-related changes (kept concise)
  try { console.log('buildCharts settings', { incColor, decColor, smoothing: smoothing ? 'smooth' : 'sharp', graphStyle }); } catch(e){}

  // single dataset with per-segment gradient coloring using Chart.js `segment` option
  // Convert series values to the selected currency so all datasets use the same units
  const convertedSeries = {
    labels: series.labels,
    values: (series.values || []).map(v => Number(v) * (currencyRates[selectedCurrency] || 1)),
    volumes: (series.volumes || []).map(v => Number(v) * (currencyRates[selectedCurrency] || 1))
  };
  if(series.ohlc) {
    convertedSeries.ohlc = series.ohlc.map(d => ({
      o: Number(d.o) * (currencyRates[selectedCurrency] || 1),
      h: Number(d.h) * (currencyRates[selectedCurrency] || 1),
      l: Number(d.l) * (currencyRates[selectedCurrency] || 1),
      c: Number(d.c) * (currencyRates[selectedCurrency] || 1),
      v: Number(d.v) * (currencyRates[selectedCurrency] || 1)
    }));
  }

  const values = convertedSeries.values || [];
  // compute maximum absolute delta between consecutive points to normalize blend strength
  const maxAbsDelta = values.reduce((mx, v, i) => {
    if(i === 0) return mx;
    const d = Math.abs(v - values[i-1]);
    return d > mx ? d : mx;
  }, 0) || 1;
  const incRgb = hexToRgb(incColor);
  const decRgb = hexToRgb(decColor);

  // Coerce Y-axis min/max inputs to numbers (avoid passing empty strings)
  const yMinRaw = document.getElementById('chartYMin')?.value;
  const yMaxRaw = document.getElementById('chartYMax')?.value;
  const yMin = (typeof yMinRaw !== 'undefined' && yMinRaw !== '') ? Number(yMinRaw) : undefined;
  const yMax = (typeof yMaxRaw !== 'undefined' && yMaxRaw !== '') ? Number(yMaxRaw) : undefined;

  if(mainChart) {
    mainChart.destroy();
    mainChart = null;
  }
  if(!aCtx) return; // Exit if context doesn't exist
  mainChart = new Chart(aCtx, {
    type: 'line',
    data: {
      labels: series.labels,
      datasets: [
        // Convert values to selected currency
        {
          type: 'line',
          label: 'Bakiye (' + currencySymbols[selectedCurrency] + ')',
          data: convertedSeries.values,
          borderColor: incColor,
          backgroundColor: 'transparent',
          borderWidth: 2,
          tension: smoothing ? 0.4 : 0,
          pointRadius: 0,
          pointHoverRadius: 6,
          pointBackgroundColor: incColor,
          pointHoverBackgroundColor: incColor,
          segment: {
            borderColor: ctx => {
              const p0 = ctx.p0.parsed && typeof ctx.p0.parsed.y === 'number' ? ctx.p0.parsed.y : 0;
              const p1 = ctx.p1.parsed && typeof ctx.p1.parsed.y === 'number' ? ctx.p1.parsed.y : 0;
              return p1 >= p0 ? incColor : decColor;
            }
          }
        },
        // Candlestick (bitcoin) or line (classic)
        ...(graphStyle === 'bitcoin' ? [{
          type: 'candlestick',
          label: currentMode === 'per' ? 'Bakiye (işlem bazlı)' : 'Bakiye',
          data: (convertedSeries.ohlc || []).map(d => ({ o: d.o, h: d.h, l: d.l, c: d.c })),
          yAxisID: 'y',
          borderWidth: 1,
          color: decColor,
          borderColor: decColor,
          wickColor: decColor,
          upColor: incColor,
          upBorderColor: incColor,
          upWickColor: incColor
        }] : [{
          type: 'line',
          label: currentMode === 'per' ? 'Bakiye (işlem bazlı)' : 'Bakiye',
          data: convertedSeries.values,
          borderColor: incColor,
          backgroundColor: 'transparent',
          yAxisID: 'y',
          fill: false,
          tension: smoothing ? 0.25 : 0,
          pointRadius: 3,
          pointBackgroundColor: function(ctx){
            const i = ctx.dataIndex;
            if(typeof i === 'undefined' || i === 0) return incColor;
            const prev = (convertedSeries.values || [])[i-1] || 0;
            const cur = (convertedSeries.values || [])[i] || 0;
            return cur >= prev ? incColor : decColor;
          },
          segment: {
            borderColor: ctx => {
              const p0 = ctx.p0.parsed && typeof ctx.p0.parsed.y === 'number' ? ctx.p0.parsed.y : 0;
              const p1 = ctx.p1.parsed && typeof ctx.p1.parsed.y === 'number' ? ctx.p1.parsed.y : 0;
              return p1 >= p0 ? incColor : decColor;
            }
          }
        }]),
        // Volume bars (only in bitcoin style)
        ...(graphStyle === 'bitcoin' ? [{
          type: 'bar',
          label: 'İşlem Hacmi',
          data: convertedSeries.volumes,
          yAxisID: 'y1',
          backgroundColor: (convertedSeries.values || []).map((v, i) => {
            if(i === 0) return hexToRgba(incColor, 0.3);
            const prev = (convertedSeries.values || [])[i-1] || 0;
            return v >= prev ? hexToRgba(incColor, 0.3) : hexToRgba(decColor, 0.3);
          }),
          borderWidth: 0,
          barThickness: 4
        }] : []),
        // Simple Moving Average (SMA20) - only in bitcoin style
        ...(graphStyle === 'bitcoin' ? [{
          type: 'line',
          label: 'SMA20',
          data: calculateSMA(values, 20),
          yAxisID: 'y',
          borderColor: '#ffeb3b',
          borderWidth: 1.5,
          borderDash: [4, 3],
          pointRadius: 0,
          fill: false
        }] : [])
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'nearest', intersect: false },
      maintainAspectRatio: false,
      onResize: function(chart, size) {
        // Keep CSS width responsive and apply user height via CSS only
        const heightInput = document.getElementById('chartHeight');
        if (heightInput) {
          const height = parseInt(heightInput.value);
          if (height >= 100 && height <= 800) {
            chart.canvas.style.width = '100%';
            chart.canvas.style.height = height + 'px';
          }
        }
      },
      plugins: {
        legend: { 
          display: graphStyle === 'bitcoin',
          position: 'bottom',
          labels: { usePointStyle: true }
        },
        tooltip: {
          // Use external tooltip: prevent internal drawing but let Chart compute the model
          enabled: false,
          external: customTooltip,
          mode: 'index',
          intersect: false,
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              if (label) label += ': ';
              if (context.parsed && context.parsed.y !== null) {
                label += formatConverted(context.parsed.y, selectedCurrency);
              }
              return label;
            }
          }
        },
        // Hook used previously to apply canvas height from the input
        afterLayout: function(chart) {
          const heightInput = document.getElementById('chartHeight');
          if (heightInput) {
            const height = parseInt(heightInput.value);
            if (height >= 100 && height <= 800) {
              chart.canvas.style.width = '100%';
              chart.canvas.style.height = height + 'px';
              try { chart.resize(); } catch(e){ /* ignore resize errors */ }
            }
          }
        }
      },
      layout: {
        padding: { left: 10, right: 10, top: 20, bottom: 10 }
      },
      backgroundColor: '#131722',
      borderColor: 'rgba(255,255,255,0.1)',
      scales: {
        x: {
          grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false },
          ticks: { color: '#9f9fa8' }
        },
        y: {
          grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false },
          ticks: { color: '#9f9fa8', callback: v => formatConverted(v, selectedCurrency) },
          min: (typeof yMin !== 'undefined' && !Number.isNaN(yMin)) ? yMin : undefined,
          max: (typeof yMax !== 'undefined' && !Number.isNaN(yMax)) ? yMax : undefined,
          suggestedMin: (typeof yMin !== 'undefined' && !Number.isNaN(yMin)) ? yMin : undefined,
          suggestedMax: (typeof yMax !== 'undefined' && !Number.isNaN(yMax)) ? yMax : undefined
        },
        ...(graphStyle === 'bitcoin' ? {
          y1: {
            position: 'right',
            grid: { drawOnChartArea: false, drawBorder: false },
            ticks: { color: '#9f9fa8', callback: v => formatTLNumber(v) }
          }
        } : {})
      }
    }
  });

  // attach helpful mappings to the chart instance so external tooltip can
  // map a datapoint index back to a YYYY-MM-DD key (for period mode) or to
  // the original transaction list (for per-transaction mode)
  try{ if(mainChart){ mainChart._dateKeys = series.dateKeys || null; mainChart._txs = series.txs || null; mainChart._chartMode = currentMode || null; } } catch(e){}

  // removed temporary mousemove debug handler (was forcing customTooltip)

  // summary doughnut under the analysis
  if (summaryChart) {
    summaryChart.destroy();
    summaryChart = null;
  }
  const ctx = document.getElementById('summaryChart').getContext('2d');
  const convertedIncome = income * currencyRates[selectedCurrency];
  const convertedExpense = expense * currencyRates[selectedCurrency];
  
  summaryChart = new Chart(ctx, {
    type:'doughnut',
    data:{ 
      labels:['Gelir','Gider'], 
      datasets:[{ 
        data:[convertedIncome, convertedExpense], 
        backgroundColor:['#00c853','#ff5252'] 
      }]
    },
    options:{
      plugins:{
        legend:{position:'bottom'},
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.raw;
              const label = context.chart.data.labels[context.dataIndex];
              return label + ': ' + formatConverted(value, selectedCurrency);
            }
          }
        }
      }, 
      maintainAspectRatio:false
    }
  });

  // Add a 'Yukarı Çık' button under the charts so desktop users can jump back up
  try{
    const scrollBtn = document.getElementById('chartScrollUpBtn');
    if(scrollBtn){
      scrollBtn.addEventListener('click', (e) => { e.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' }); });
    }
  }catch(e){/* ignore */}

  // Scroll-up indicator logic: show fixed indicator when balance is not visible (desktop only)
  (function(){
    const indicator = document.getElementById('scrollUpIndicator');
    const balanceEl = document.getElementById('balanceValue');
    if(!indicator || !balanceEl) return;
    function check() {
      try{
        if(window.innerWidth < 768){ indicator.style.display = 'none'; return; }
        const rect = balanceEl.getBoundingClientRect();
        const visible = rect.bottom > 0 && rect.top < window.innerHeight;
        indicator.style.display = visible ? 'none' : 'flex';
      }catch(e){ }
    }
    indicator.addEventListener('click', ()=> { window.scrollTo({ top: 0, behavior: 'smooth' }); });
    window.addEventListener('scroll', check);
    window.addEventListener('resize', check);
    // initial check
    setTimeout(check, 300);
  })();

  // update balance anim and summary text with currency conversion
  const convertedTotal = total * currencyRates[selectedCurrency];
  animateBalanceTo(convertedTotal);
  metaSub.textContent = `${view.length} işlem görüntüleniyor`;
}

// build per-transaction series (cumulative after each transaction in range)
function buildTransactionSeries(recordsList, range){
  // Build a per-transaction cumulative series for the transaction ('per') mode.
  // The function will return one point per transaction within the selected
  // date window (weekly/monthly/yearly/all). If there are no transactions in
  // the window, fall back to daily-bucketed series so the chart still shows
  // the full time range.
  const today = new Date(); today.setHours(0,0,0,0);
  let startDate;
  if(range === 'weekly') { startDate = new Date(today); startDate.setDate(today.getDate() - 6); }
  else if(range === 'monthly') { startDate = new Date(today); startDate.setDate(today.getDate() - 29); }
  else if(range === 'yearly') { startDate = new Date(today); startDate.setDate(today.getDate() - 364); }
  else { // all -> start at earliest record date
    const allDates = (records || []).map(r=>new Date(r.date + 'T00:00:00'));
    startDate = allDates.length ? new Date(Math.min(...allDates)) : new Date(); startDate.setHours(0,0,0,0);
  }

  // Normalize input items and include original order info
  const items = (recordsList || []).map(r => ({ id: r.id, date: r.date, amt: (r.type === 'income' ? r.amount : -r.amount), note: r.note, type: r.type, amount: r.amount }));
  items.forEach(it => { it.d = new Date(it.date + 'T00:00:00'); });

  // Transactions within window (inclusive)
  const txInWindow = items.slice().filter(it => it.d >= startDate && it.d <= today).sort((a,b) => a.d - b.d || String(a.id || '').localeCompare(String(b.id || '')));

  // If no transactions present in window, fallback to daily buckets (previous behavior)
  if(!txInWindow.length){
    // fallback: daily buckets
    const dayKeys = [];
    const changesByDay = new Map();
    const volByDay = new Map();
    for(let d = new Date(startDate); d <= today; d.setDate(d.getDate()+1)){
      const key = d.toISOString().slice(0,10);
      dayKeys.push(key);
      changesByDay.set(key, 0);
      volByDay.set(key, 0);
    }
    const sortedItems = items.slice().sort((a,b) => a.d - b.d || String(a.date).localeCompare(String(b.date)) );
    for(const it of sortedItems){
      const key = it.d.toISOString().slice(0,10);
      if(changesByDay.has(key)){
        changesByDay.set(key, (changesByDay.get(key) || 0) + it.amt);
        volByDay.set(key, (volByDay.get(key) || 0) + Math.abs(it.amt));
      }
    }
    // prior cumulative from records before startDate
    let priorCum = 0;
    for(const rr of (records || [])){
      const d = new Date(rr.date + 'T00:00:00'); if(d < startDate) priorCum += (rr.type === 'income' ? rr.amount : -rr.amount);
    }
    const labels = [];
    const values = [];
    const volumes = [];
    let cum = priorCum;
    for(const key of dayKeys){
      const d = new Date(key + 'T00:00:00');
      labels.push(d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' }));
      cum += (changesByDay.get(key) || 0);
      values.push(Math.round(cum*100)/100);
      volumes.push(volByDay.get(key) || 0);
    }
    return { labels, values, volumes };
  }

  // Compute prior cumulative balance from records earlier than startDate
  let priorCum = 0;
  for(const rr of (records || [])){
    const d = new Date(rr.date + 'T00:00:00'); if(d < startDate) priorCum += (rr.type === 'income' ? rr.amount : -rr.amount);
  }

  const labels = [];
  const values = [];
  const volumes = [];
  let cum = priorCum;
  for(const tx of txInWindow){
    cum += tx.amt;
    // label per transaction: date + short note (if present)
    const dLabel = tx.d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' });
    const notePart = tx.note ? (' • ' + String(tx.note).slice(0,18)) : '';
    labels.push(dLabel + notePart);
    values.push(Math.round(cum*100)/100);
    volumes.push(Math.abs(tx.amt));
  }

  // return the txs as well so consumers (tooltip) can map a dataIndex back to the
  // original transaction metadata (note, type, amount, id)
  return { labels, values, volumes, txs: txInWindow };
}

// helper: convert hex to rgba
function hexToRgba(hex, alpha){
  if(!hex) return `rgba(108,99,255,${alpha})`;
  const h = hex.replace('#',''); const bigint = parseInt(h,16);
  const r = (bigint >> 16) & 255; const g = (bigint >> 8) & 255; const b = bigint & 255;
  return `rgba(${r},${g},${b},${alpha})`;
}

// custom tooltip to show detailed info on hover (works for both period and per-transaction modes)
function customTooltip(context){
  // simple external tooltip: use title and body
  const chart = context.chart;
  // Quick invocation log to verify the function is running (gated)
  try { dbg('customTooltip invoked', { hasChart: !!chart, chartId: chart && chart.canvas && chart.canvas.id }); } catch(e){ /* ignore */ }
  const tooltipEl = document.getElementById('chartTooltip');
  if(!tooltipEl){
    const div = document.createElement('div'); div.id = 'chartTooltip'; div.style.position='absolute'; div.style.pointerEvents='none'; div.style.background='var(--card)'; div.style.border='1px solid var(--border)'; div.style.padding='8px'; div.style.borderRadius='8px'; div.style.boxShadow='0 6px 20px rgba(0,0,0,0.08)'; div.style.zIndex=2000; div.style.display='none'; document.body.appendChild(div);
  }
  const el = document.getElementById('chartTooltip');
  const tooltipModel = context.tooltip;
  if(tooltipModel.opacity === 0){ el.style.display = 'none'; return; }
  if(tooltipModel.dataPoints){
    const dp = tooltipModel.dataPoints[0];
    const label = dp.label || '';
    const graphStyleEl = document.querySelector('#chartGraphStyle [data-graph].active');
    const graphStyle = graphStyleEl ? graphStyleEl.getAttribute('data-graph') : 'bitcoin';
    
    let html = `<div style="font-weight:700">${label}</div>`;
    
    const selectedCurrency = (document.getElementById('currencySelect') && document.getElementById('currencySelect').value) || 'TRY';
    if(graphStyle === 'bitcoin' && dp.raw && typeof dp.raw === 'object'){
      const ohlc = dp.raw;
      html += `
        <div style="margin-top:6px">Açılış: ${formatConverted(ohlc.o, selectedCurrency)}</div>
        <div>En Yüksek: ${formatConverted(ohlc.h, selectedCurrency)}</div>
        <div>En Düşük: ${formatConverted(ohlc.l, selectedCurrency)}</div>
        <div>Kapanış: ${formatConverted(ohlc.c, selectedCurrency)}</div>
      `;
    } else {
      // Prefer raw numeric value when available. If formattedValue is present
      // (contains currency symbols / thousands separators) attempt to extract
      // a numeric value safely. If parsing fails, fall back to showing the
      // original formatted string.
      let numericValue = null;
      if (dp.raw !== undefined && typeof dp.raw === 'number' && isFinite(dp.raw)) {
        numericValue = dp.raw;
      } else if (dp.raw !== undefined && typeof dp.raw === 'string') {
        // try to strip non-numeric characters, handle comma as decimal
        const cleaned = dp.raw.replace(/[^0-9\-\.,]/g, '').replace(/,/g, '.');
        const n = Number(cleaned);
        if (isFinite(n)) numericValue = n;
      }
      if (numericValue === null && dp.formattedValue && typeof dp.formattedValue === 'string') {
        const cleaned = dp.formattedValue.replace(/[^0-9\-\.,]/g, '').replace(/,/g, '.');
        const n = Number(cleaned);
        if (isFinite(n)) numericValue = n;
      }

      if (numericValue !== null && isFinite(numericValue)) {
        html += `<div style="margin-top:6px">Bakiye: ${formatConverted(numericValue, selectedCurrency)}</div>`;
      } else {
        // as a last resort, show the raw/formatted text
        const textVal = dp.formattedValue || dp.raw || '';
        html += `<div style="margin-top:6px">Bakiye: ${escapeHtml(String(textVal))}</div>`;
      }

      // Now enrich tooltip content based on current chart mode:
      try{
        const modeBtn = document.querySelector('#analysisMode [data-mode].active');
        const currentMode = modeBtn ? modeBtn.getAttribute('data-mode') : (chart && chart._chartMode) || 'period';
        const dataIndex = (dp.dataIndex !== undefined ? dp.dataIndex : (dp.index !== undefined ? dp.index : null));

        if(currentMode === 'period'){
          // Map dataIndex -> YYYY-MM-DD using attached dateKeys on chart
          const dateKey = (chart && chart._dateKeys && dataIndex !== null) ? chart._dateKeys[dataIndex] : null;
          if(dateKey){
            const dayRecs = (records || []).filter(r => r.date === dateKey);
            if(dayRecs && dayRecs.length){
              html += `<div style="margin-top:8px; font-weight:600">O günkü işlemler:</div>`;
              html += `<div style="margin-top:6px; max-height:160px; overflow:auto; padding-right:6px">`;
              for(const r of dayRecs){
                const col = (r.type === 'income') ? 'var(--income)' : 'var(--expense)';
                const note = escapeHtml(r.note || '(not yok)');
                const amt = formatCurrency(r.amount, selectedCurrency);
                html += `<div style="display:flex;justify-content:space-between;gap:10px;margin-bottom:6px"><div style="color:${col};font-weight:600">${note}</div><div style="color:${col};font-weight:600">${amt}</div></div>`;
              }
              html += `</div>`;
            }
          }
        } else if(currentMode === 'per'){
          // per-transaction mode: chart._txs maps dataIndex -> tx metadata
          const tx = (chart && chart._txs && dataIndex !== null) ? chart._txs[dataIndex] : null;
          if(tx){
            const col = (tx.type === 'income') ? 'var(--income)' : 'var(--expense)';
            const note = escapeHtml(tx.note || '(not yok)');
            const amt = formatCurrency(tx.amount || Math.abs(tx.amt || 0), selectedCurrency);
            html += `<div style="margin-top:8px; display:flex;justify-content:space-between;gap:10px"><div style="font-weight:600;color:${col}">${note}</div><div style="font-weight:600;color:${col}">${amt}</div></div>`;
          }
        }
      }catch(e){ /* ignore enrichment errors */ }
    }
    
    el.innerHTML = html;
    const canvasRect = chart.canvas.getBoundingClientRect();
    const scaleX = canvasRect.width / chart.width || 1;
    const scaleY = canvasRect.height / chart.height || 1;
    const caretX = (typeof tooltipModel.caretX === 'number') ? tooltipModel.caretX : (tooltipModel.dataPoints && tooltipModel.dataPoints[0] && tooltipModel.dataPoints[0].element && tooltipModel.dataPoints[0].element.x) || 0;
    const caretY = (typeof tooltipModel.caretY === 'number') ? tooltipModel.caretY : (tooltipModel.dataPoints && tooltipModel.dataPoints[0] && tooltipModel.dataPoints[0].element && tooltipModel.dataPoints[0].element.y) || 0;
    // DEBUG LOGS (compact JSON) - print only primitives so it's copy/paste friendly
    try {
      const dbgObj = {
        canvasLeft: Math.round(canvasRect.left*100)/100,
        canvasTop: Math.round(canvasRect.top*100)/100,
        canvasWidth: Math.round(canvasRect.width*100)/100,
        canvasHeight: Math.round(canvasRect.height*100)/100,
        chartWidth: Math.round(chart.width*100)/100,
        chartHeight: Math.round(chart.height*100)/100,
        scaleX: Number(scaleX.toFixed(6)),
        scaleY: Number(scaleY.toFixed(6)),
        caretX: Math.round(caretX*100)/100,
        caretY: Math.round(caretY*100)/100,
        dpIndex: (dp && (dp.index || (dp.dataIndex !== undefined ? dp.dataIndex : null))) || null,
        dpDataset: (dp && (dp.datasetIndex || (dp.datasetIndex !== undefined ? dp.datasetIndex : null))) || null,
        dpRaw: (dp && dp.raw) ? (typeof dp.raw === 'object' ? JSON.stringify(dp.raw) : String(dp.raw)) : null
      };
      dbg('tooltip-debug-json', JSON.stringify(dbgObj));
    } catch(e){ dbg('tooltip-debug-json error', e); }
    el.style.left = (canvasRect.left + window.scrollX + caretX * scaleX + 12) + 'px';
    el.style.top = (canvasRect.top + window.scrollY + caretY * scaleY - 10) + 'px';
    el.style.display = 'block';
  }
}

// color helpers: hex -> rgb and lerp
function hexToRgb(hex){
  const h = (hex||'#000000').replace('#','');
  const bigint = parseInt(h,16);
  return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
}
function lerp(a,b,t){ return a + (b - a) * t; }
function rgbToRgbaString(rgb, a){ return `rgba(${Math.round(rgb.r)},${Math.round(rgb.g)},${Math.round(rgb.b)},${a})`; }

// calculate Simple Moving Average (SMA)
function calculateSMA(data, period) {
  const result = [];
  for(let i = 0; i < data.length; i++) {
    if(i < period - 1) {
      result.push(null);  // not enough data yet
      continue;
    }
    const sum = data.slice(i - period + 1, i + 1).reduce((a,b) => a + b, 0);
    result.push(Math.round((sum / period) * 100) / 100);
  }
  return result;
}

// Helper: build cumulative balance series for a given range
function buildBalanceSeries(recordsList, range){
  // normalize records to dates and signed amounts
  const items = recordsList.map(r => ({ date: r.date, amt: (r.type === 'income' ? r.amount : -r.amount) }));
  // convert string dates to Date objects (assumes YYYY-MM-DD)
  items.forEach(it => { it.d = new Date(it.date + 'T00:00:00'); });

  const today = new Date();
  today.setHours(0,0,0,0);
  let startDate;
  if(range === 'weekly'){
    startDate = new Date(today); startDate.setDate(today.getDate() - 6); // last 7 days inclusive
  } else if(range === 'monthly'){
    startDate = new Date(today); startDate.setDate(today.getDate() - 29); // last 30 days
  } else if(range === 'yearly'){
    startDate = new Date(today); startDate.setDate(today.getDate() - 364); // last 365 days
  } else { // all
    const dates = items.map(i=>i.d).filter(Boolean);
    startDate = dates.length ? new Date(Math.min(...dates)) : new Date(); startDate.setHours(0,0,0,0);
  }

  // build daily OHLC (Open, High, Low, Close) buckets from startDate to today
  const byKey = new Map();
  const volByKey = new Map();
  const ohlcMap = new Map();
  const labels = [];
  
  for(let d = new Date(startDate); d <= today; d.setDate(d.getDate()+1)){
    const key = d.toISOString().slice(0,10);
    byKey.set(key, 0);
    volByKey.set(key, 0);
    ohlcMap.set(key, { o: null, h: -Infinity, l: Infinity, c: null, v: 0 });
    // label as DD.MM
    labels.push(new Date(d).toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' }));
  }

  // First pass: aggregate running balance at start of each day for open prices
  let runningBalance = 0;
  const sortedItems = items.slice().sort((a,b) => a.d.getTime() - b.d.getTime());
  for(const it of sortedItems){
    const key = it.d.toISOString().slice(0,10);
    if(ohlcMap.has(key)){
      const ohlc = ohlcMap.get(key);
      if(ohlc.o === null) ohlc.o = runningBalance; // capture day's opening balance
      runningBalance += it.amt;
      ohlc.h = Math.max(ohlc.h, runningBalance); // update high
      ohlc.l = Math.min(ohlc.l, runningBalance); // update low
      ohlc.c = runningBalance; // keep updating close until day's last tx
      ohlc.v += Math.abs(it.amt); // accumulate volume
    }
  }

  // Fill any missing OHLC values and convert to final balance series
  let prevClose = 0;
  for(const key of ohlcMap.keys()){
    const ohlc = ohlcMap.get(key);
    if(ohlc.o === null) ohlc.o = prevClose;
    if(ohlc.h === -Infinity) ohlc.h = ohlc.o;
    if(ohlc.l === Infinity) ohlc.l = ohlc.o;
    if(ohlc.c === null) ohlc.c = ohlc.o;
    prevClose = ohlc.c;
    byKey.set(key, ohlc.c - ohlc.o); // store net change
    volByKey.set(key, ohlc.v);
  }

  // compute prior cumulative balance from records earlier than startDate (use full dataset 'records')
  let priorCum = 0;
  for(const rr of (records || [])){
    const d = new Date(rr.date + 'T00:00:00'); if(d < startDate) priorCum += (rr.type === 'income' ? rr.amount : -rr.amount);
  }

  // produce OHLC, cumulative series and volumes
  const values = [];
  const volumes = [];
  const ohlc = [];
  let cum = priorCum;
  
  // iterate keys in date order
  const orderedKeys = Array.from(byKey.keys()).sort();
  for(const k of orderedKeys){ 
    const dayOhlc = ohlcMap.get(k);
    cum += byKey.get(k) || 0;
    values.push(Math.round(cum*100)/100);
    volumes.push(volByKey.get(k) || 0);
    ohlc.push({
      o: Math.round(dayOhlc.o*100)/100,
      h: Math.round(dayOhlc.h*100)/100,
      l: Math.round(dayOhlc.l*100)/100,
      c: Math.round(dayOhlc.c*100)/100,
      v: dayOhlc.v
    });
  }
  return { labels, values, volumes, ohlc, dateKeys: orderedKeys };
}

function getWeekNumber(d){
  // ISO week number
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1)/7);
  return String(weekNo).padStart(2,'0');
}

/* Render list */
function renderRecords(){
  recordsEl.innerHTML = '';
  const view = getFilteredRecords();

  // render items
  // precompute cumulative balance per record using the FULL dataset (all records)
  // so that filtering/search does not change the absolute balances shown for each record.
  const balanceById = {};
  try{
    // use the global `records` array (all transactions) sorted ascending by date
    const asc = (records || []).slice().sort((a,b) => a.date.localeCompare(b.date) || String(a.id).localeCompare(String(b.id)) );
    let cum = 0;
    for(const it of asc){
      cum += (it.type === 'income' ? it.amount : -it.amount);
      balanceById[it.id] = Math.round(cum*100)/100;
    }
  }catch(e){ console.error('[renderRecords] balance calc failed', e); }

  for(const r of view){
    const div = document.createElement('div');
    div.className = 'record-card ' + (r.type === 'income' ? 'income' : 'expense');
    const tagsHtml = (r.tags || []).map(t => `<span class="tag-chip">${escapeHtml(t)}</span>`).join('');
    const prettyBal = formatTLNumber(balanceById[r.id] || 0);
    div.innerHTML = `
      <div>
        <div style="font-weight:700">${escapeHtml(r.note)}</div>
        <div class="small muted" style="margin-top:6px">${r.date}${tagsHtml ? ' • ' : ''}${tagsHtml}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:800; color:${r.type === 'income' ? 'var(--income)' : 'var(--expense)'}">
          ${r.type==='income' ? '+' : '-'}${formatTLNumber(r.amount)} ₺
        </div>
        <div style="font-size:.85rem; color:var(--muted); margin-top:6px">Bakiye: ${prettyBal} ₺</div>
        <div class="mt-2">
          <button class="btn btn-sm btn-outline-secondary me-1" onclick="openEdit('${r.id}')"><i class="fas fa-edit"></i></button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('${r.id}')"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    `;
    recordsEl.appendChild(div);
  }

  updateChartsForView();
}

/* escape html */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c])); }

/* Open modal add */
function openAdd(){
  editingId = null;
  document.getElementById('modalTitle').textContent = 'Yeni İşlem';
  d_amount.value = '';
  d_note.value = '';
  d_tags.value = '';
  d_date.value = new Date().toISOString().slice(0,10);
  showMainModal();
}

/* Open edit */
function openEdit(id){
  const rec = records.find(r=>r.id === id);
  if(!rec) return alert('Kayıt bulunamadı');
  editingId = id;
  document.getElementById('modalTitle').textContent = 'İşlemi Düzenle';
  d_amount.value = rec.type === 'income' ? String(rec.amount) : String(-rec.amount);
  d_note.value = rec.note;
  d_tags.value = (rec.tags || []).join(', ');
  d_date.value = rec.date;
  showMainModal();
}

/* Close modal */
function closeModal(){
  editingId = null;
  hideMainModal();
}

// Show/hide helpers with animation for the add/edit modal
function showMainModal(){
  try{
    const m = document.getElementById('modalOverlay');
    if(!m) return;
    m.style.display = 'flex';
    m.setAttribute('aria-hidden','false');
    // ensure any prior closing class removed, then add 'show' on next frame so transition runs
    m.classList.remove('closing');
    requestAnimationFrame(()=> m.classList.add('show'));
  }catch(e){ try{ document.getElementById('modalOverlay').style.display='flex'; }catch(_){} }
}

function hideMainModal(){
  try{
    const m = document.getElementById('modalOverlay');
    if(!m) return;
    // add a closing class to start the reverse animation, wait for transition to finish
    m.classList.add('closing');
    const box = m.querySelector('.modal-box');
    const onEnd = (ev) => {
      // ensure we react to the box's transition end
      if(ev && ev.target !== box) return;
      try{ if(box) box.removeEventListener('transitionend', onEnd); }catch(e){}
      try{ m.classList.remove('show'); m.classList.remove('closing'); m.style.display='none'; m.setAttribute('aria-hidden','true'); }catch(e){}
    };
    if(box) box.addEventListener('transitionend', onEnd);
    // fallback in case transitionend doesn't fire
    setTimeout(onEnd, 520);
  }catch(e){ try{ document.getElementById('modalOverlay').style.display='none'; }catch(_){} }
}

// allow clicking outside the modal-box to close the overlay (common UX)
(function wireMainModalOverlay(){
  try{
    const m = document.getElementById('modalOverlay');
    if(!m) return;
    m.addEventListener('click', (e)=>{ if(e.target === m) hideMainModal(); });
  }catch(e){}
})();

// --- Wire amount/type interactions for add/edit modal ---
(function wireAmountAndType(){
  try{
    const amt = document.getElementById('d_amount');
    const type = document.getElementById('d_type');
    if(!amt || !type) return;

    function applyVisualFor(t){
      amt.classList.remove('income','expense');
      type.classList.remove('income','expense');
      if(t === 'income'){
        amt.classList.add('income');
        type.classList.add('income');
      } else if(t === 'expense'){
        amt.classList.add('expense');
        type.classList.add('expense');
      }
    }

    function inferTypeFromInput(v){
      if(!v) return null;
      const trimmed = String(v).trim();
      // leading sign preference
      if(/^\s*[-−]/.test(trimmed)) return 'expense';
      if(/^\s*[+]/.test(trimmed)) return 'income';
      // numeric sign check
      const n = Number(trimmed.replace(/,/g, '.'));
      if(!Number.isNaN(n)){
        if(n < 0) return 'expense';
        if(n > 0) return 'income';
      }
      return null;
    }

    // when user types amount, infer and update select (unless user explicitly picks income/expense?)
    amt.addEventListener('input', (ev)=>{
      const v = ev.target.value;
      const inferred = inferTypeFromInput(v);
      if(inferred){
        // set select to inferred
        type.value = inferred;
        applyVisualFor(inferred);
      } else {
        // if auto, clear styles
        if(type.value === 'auto'){
          amt.classList.remove('income','expense');
          type.classList.remove('income','expense');
        }
      }
    });

    // when user changes the select, update input visuals
    type.addEventListener('change', ()=>{
      const v = type.value;
      if(v === 'income' || v === 'expense') applyVisualFor(v);
      else { amt.classList.remove('income','expense'); type.classList.remove('income','expense'); }
    });

    // when modal opens we should re-evaluate current value
    const origShow = window.showMainModal;
    if(typeof origShow === 'function'){
      window.showMainModal = function(){
        try{ origShow(); } catch(e){}
        // small delay to allow DOM to render then infer
        setTimeout(()=>{
          const inferred = inferTypeFromInput(amt.value);
          if(inferred){ type.value = inferred; applyVisualFor(inferred); }
          else if(type.value === 'auto'){ amt.classList.remove('income','expense'); type.classList.remove('income','expense'); }
        }, 8);
      };
    }
  }catch(e){/* ignore wiring errors */}
})();

/* Save (add/edit) -> uses saveRecords() implemented after Firebase is ready */
d_save.addEventListener('click', () => {
  const rawAmt = d_amount.value.trim();
  const rawNote = d_note.value.trim();
  const rawTags = d_tags.value.trim();
  const rawDate = d_date.value || new Date().toISOString().slice(0,10);
  const val = parseFloat(rawAmt.replace(/,/g,'.'));
  if(isNaN(val) || val === 0){ alert('Geçerli bir tutar gir (pozitif veya negatif sayı).'); return; }

  // Decide type: prefer explicit select unless it's 'auto'
  let chosenType = 'expense';
  try{ const sel = document.getElementById('d_type'); if(sel && sel.value && sel.value !== 'auto') chosenType = sel.value; else chosenType = (val > 0 ? 'income' : 'expense'); }catch(e){ chosenType = (val > 0 ? 'income' : 'expense'); }

  if(editingId === null){
    const rec = {
      id: String(Date.now() + Math.floor(Math.random()*999)),
      amount: Math.abs(val),
      type: chosenType,
      note: rawNote || '(not yok)',
      tags: rawTags ? rawTags.split(',').map(t=>t.trim()).filter(Boolean) : [],
      date: rawDate
    };
    records.push(rec);
  } else {
    const rec = records.find(r=>r.id === editingId);
    if(!rec) { alert('Düzenlenecek kayıt bulunamadı'); editingId = null; closeModal(); return; }
    rec.amount = Math.abs(val);
    rec.type = chosenType;
    rec.note = rawNote || '(not yok)';
    rec.tags = rawTags ? rawTags.split(',').map(t=>t.trim()).filter(Boolean) : [];
    rec.date = rawDate;
  }
  // persist (saveRecords replaced by firebase writer when available)
  saveRecords();
  closeModal();
  renderRecords();
});

/* Delete */
function deleteRecord(id){
  // open custom confirmation modal
  try{
    showDeleteConfirm(id);
  }catch(e){
    // fallback to old behavior
    if(!confirm('Bu kaydı silmek istiyor musun?')) return;
    records = records.filter(r=> r.id !== id);
    saveRecords();
    renderRecords();
  }
}

// Show custom delete confirmation modal and wire handlers
let __pendingDeleteId = null;
function showDeleteConfirm(id){
  __pendingDeleteId = id;
  const m = document.getElementById('deleteConfirmModal');
  if(!m) return;
  // ensure visible then add .show on next frame so CSS transition runs
  m.style.display = 'flex';
  m.setAttribute('aria-hidden','false');
  requestAnimationFrame(()=> { m.classList.add('show'); });
}
function hideDeleteConfirm(){
  const m=document.getElementById('deleteConfirmModal');
  if(!m) return;
  const inner = m.querySelector('.modal-inner');
  // remove visible class to start closing transition
  m.classList.remove('show');
  // wait for transition on inner to finish then hide
  const done = () => {
    try{ m.style.display = 'none'; m.setAttribute('aria-hidden','true'); }catch(e){}
    try{ inner.removeEventListener('transitionend', done); }catch(e){}
  };
  if(inner) inner.addEventListener('transitionend', done);
  // fallback hide in case transitionend doesn't fire
  setTimeout(done, 260);
  __pendingDeleteId = null;
}

// Attach delete modal buttons immediately (modal exists in DOM now)
(function wireDeleteModal(){
  try{
    const cancelBtn = document.getElementById('cancelDeleteBtn');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    if(cancelBtn) cancelBtn.addEventListener('click', ()=> hideDeleteConfirm());
    if(confirmBtn) confirmBtn.addEventListener('click', ()=>{
      try{
        if(__pendingDeleteId){ records = records.filter(r=> r.id !== __pendingDeleteId); saveRecords(); renderRecords(); }
      }catch(e){}
      hideDeleteConfirm();
    });
  }catch(e){ /* ignore wiring errors */ }
})();

/* UI handlers */
openAddBtn.addEventListener('click', openAdd);
floatingAdd.addEventListener('click', openAdd);
d_close.addEventListener('click', closeModal);

function setActive(btn){
  [filterAll, filterIncome, filterExpense].forEach(b=> b.classList.remove('active'));
  btn.classList.add('active');
}
filterAll.addEventListener('click', ()=> { setActive(filterAll); renderRecords(); });
filterIncome.addEventListener('click', ()=> { setActive(filterIncome); renderRecords(); });
filterExpense.addEventListener('click', ()=> { setActive(filterExpense); renderRecords(); });

searchNote.addEventListener('keydown', (e)=> { if(e.key === 'Enter') renderRecords(); });
searchNote.addEventListener('input', ()=> { renderRecords(); }); // live update -> chart updates too

/* Advanced modal handlers */
function openAdvModal() {
  advModal.style.display = 'flex';
  requestAnimationFrame(()=> {
    advContent.style.transform = 'translateY(0)';
    advContent.style.opacity = '1';
  });
}
function closeAdvModal() {
  advContent.style.transform = 'translateY(-20px)';
  advContent.style.opacity = '0';
  setTimeout(()=> advModal.style.display = 'none', 220);
}
advBtn.addEventListener('click', openAdvModal);
advClose.addEventListener('click', closeAdvModal);
advModal.addEventListener('click', e => { if(e.target === advModal) closeAdvModal(); });

advApply.addEventListener('click', ()=>{
  const minAmt = parseFloat(document.getElementById('adv_minAmount').value);
  const maxAmt = parseFloat(document.getElementById('adv_maxAmount').value);
  const startDate = document.getElementById('adv_startDate').value;
  const endDate = document.getElementById('adv_endDate').value;
  const tagQuery = (document.getElementById('adv_tag').value || '').toLowerCase().split(',').map(t=>t.trim()).filter(Boolean);
  advancedFilters = { minAmt, maxAmt, startDate, endDate, tagQuery };
  renderRecords();
  closeAdvModal();
});

/* Keyboard escape closes modals */
window.addEventListener('keydown', (e)=> { if(e.key === 'Escape') { closeModal(); closeAdvModal(); } });

/* initial render */
renderRecords();

/* Expose for inline onclick */
window.openEdit = openEdit;
window.deleteRecord = deleteRecord;

/* ---- Firebase module: Auth + RTDB sync ----
   This script sets up:
   - Firebase app, auth (email + google)
   - Realtime Database 'records' node sync (replaces localStorage)
   - sharedMessage node for small shared text (demo)
   Make sure your Firebase rules permit read/write or use Auth-protected rules.
*/

</script>

</body>
</html>